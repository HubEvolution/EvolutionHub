---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { type BillingSummary } from '@/components/dashboard/BillingCard';
import BillingCard from '@/components/dashboard/BillingCard';
import ReferralCard, { type ReferralSummary } from '@/components/dashboard/ReferralCard';
import UserProfile from '@/components/dashboard/UserProfile.astro';
import AccountSettingsSection from '@/components/dashboard/AccountSettingsSection.astro';
import NewsletterPreferencesCard from '@/components/dashboard/NewsletterPreferencesCard';
import ConsentPreferencesCard from '@/components/dashboard/ConsentPreferencesCard';
import Card from '@/components/ui/Card';
import { getLocale } from '@/lib/i18n';
import { localizePath } from '@/lib/locale-path';
import { getI18n } from '@/utils/i18n';
// V2 removes shortcuts/recommendations and extra cards

type DashboardPlanId = 'free' | 'pro' | 'premium' | 'enterprise';

type DashboardUser = {
  id: string;
  name: string;
  username: string;
  email: string;
  image?: string;
  plan?: DashboardPlanId;
};

const locals = Astro.locals as { user?: DashboardUser | null };
if (!locals.user) {
  return Astro.redirect('/login');
}

const user = locals.user;
const locale = getLocale(Astro.url.pathname);
const t = getI18n(locale);
const origin = new URL(Astro.request.url).origin;
const cookieHeader = Astro.request.headers.get('cookie') ?? '';

async function fetchApi<T>(path: string, timeoutMs = 1200): Promise<T | null> {
  const ac = new AbortController();
  const t = setTimeout(() => ac.abort('timeout'), timeoutMs);
  try {
    const res = await fetch(`${origin}${path}`, {
      headers: {
        cookie: cookieHeader,
      },
      signal: ac.signal,
    });
    if (!res.ok) return null;
    const json = (await res.json()) as { data?: T } | T | null;
    if (json && typeof json === 'object' && 'data' in (json as Record<string, unknown>)) {
      return (json as { data?: T }).data ?? null;
    }
    return (json as T) ?? null;
  } catch {
    return null;
  } finally {
    clearTimeout(t);
  }
}

type DashboardBillingSummary = BillingSummary & {
  monthlyLimit: number;
  monthlyUsed: number;
  periodEndsAt: number;
};

const referralStrings = {
  title: t('pages.dashboard.referrals.title'),
  description: t('pages.dashboard.referrals.description'),
  linkLabel: t('pages.dashboard.referrals.linkLabel'),
  copy: t('pages.dashboard.referrals.copy'),
  copied: t('pages.dashboard.referrals.copied'),
  loading: t('pages.dashboard.referrals.loading'),
  error: t('pages.dashboard.referrals.error'),
  empty: t('pages.dashboard.referrals.empty'),
  statsTitle: t('pages.dashboard.referrals.statsTitle'),
  stats: {
    referred: t('pages.dashboard.referrals.stats.referred'),
    verified: t('pages.dashboard.referrals.stats.verified'),
    paid: t('pages.dashboard.referrals.stats.paid'),
    pending: t('pages.dashboard.referrals.stats.pending'),
    cancelled: t('pages.dashboard.referrals.stats.cancelled'),
  },
  creditsEarned: t('pages.dashboard.referrals.creditsEarned'),
  recentTitle: t('pages.dashboard.referrals.recentTitle'),
  recentEmpty: t('pages.dashboard.referrals.recentEmpty'),
  status: {
    pending: t('pages.dashboard.referrals.status.pending'),
    verified: t('pages.dashboard.referrals.status.verified'),
    paid: t('pages.dashboard.referrals.status.paid'),
    cancelled: t('pages.dashboard.referrals.status.cancelled'),
  },
  updated: t('pages.dashboard.referrals.updated'),
  retry: t('pages.dashboard.referrals.retry'),
};

const billingSummary = await fetchApi<DashboardBillingSummary>('/api/dashboard/billing-summary');
const referralSummary = await fetchApi<ReferralSummary>('/api/dashboard/referral-summary');

// shortcuts removed in Dashboard V2

const billingStrings = {
  title: t('pages.dashboard.billing.title'),
  currentPlan: t('pages.dashboard.billing.currentPlan'),
  statusLabel: t('pages.dashboard.billing.statusLabel'),
  noSubscription: t('pages.dashboard.billing.noSubscription'),
  renewal: t('pages.dashboard.billing.renewal'),
  credits: t('pages.dashboard.billing.credits'),
  actions: {
    manage: t('pages.dashboard.billing.actions.manage'),
    cancel: t('pages.dashboard.billing.actions.cancel'),
    cancelled: t('pages.dashboard.billing.actions.cancelled'),
  },
  statusMap: {
    active: t('pages.dashboard.billing.statusMap.active'),
    trialing: t('pages.dashboard.billing.statusMap.trialing'),
    past_due: t('pages.dashboard.billing.statusMap.past_due'),
    canceled: t('pages.dashboard.billing.statusMap.canceled'),
    unpaid: t('pages.dashboard.billing.statusMap.unpaid'),
    incomplete: t('pages.dashboard.billing.statusMap.incomplete'),
    incomplete_expired: t('pages.dashboard.billing.statusMap.incomplete_expired'),
    paused: t('pages.dashboard.billing.statusMap.paused'),
    unknown: t('pages.dashboard.billing.statusMap.unknown'),
  } as Record<string, string>,
  planLabels: {
    free: t('pages.dashboard.profile.planLabels.free'),
    pro: t('pages.dashboard.profile.planLabels.pro'),
    premium: t('pages.dashboard.profile.planLabels.premium'),
    enterprise: t('pages.dashboard.profile.planLabels.enterprise'),
  } as Record<'free' | 'pro' | 'premium' | 'enterprise', string>,
};

const buyCreditsStrings = {
  button: t('pages.dashboard.billing.creditsBuy.button'),
  errorPrefix: t('pages.dashboard.billing.creditsBuy.errorPrefix'),
  errorInvalidResponse: t('pages.dashboard.billing.creditsBuy.errorInvalidResponse'),
  errorGeneric: t('pages.dashboard.billing.creditsBuy.errorGeneric'),
};

// tool shortcuts removed in Dashboard V2

const consentStrings = {
  title: t('pages.dashboard.consent.title'),
  description: t('pages.dashboard.consent.description'),
  manageHref: t('pages.dashboard.consent.manageHref'),
  categories: {
    necessary: {
      label: t('pages.dashboard.consent.categories.necessary.label'),
      description: t('pages.dashboard.consent.categories.necessary.description'),
    },
    analytics: {
      label: t('pages.dashboard.consent.categories.analytics.label'),
      description: t('pages.dashboard.consent.categories.analytics.description'),
    },
    marketing: {
      label: t('pages.dashboard.consent.categories.marketing.label'),
      description: t('pages.dashboard.consent.categories.marketing.description'),
    },
  },
  actions: {
    manage: t('pages.dashboard.consent.actions.manage'),
    acceptAll: t('pages.dashboard.consent.actions.acceptAll'),
    rejectAll: t('pages.dashboard.consent.actions.rejectAll'),
  },
  status: {
    granted: t('pages.dashboard.consent.status.granted'),
    limited: t('pages.dashboard.consent.status.limited'),
    disabled: t('pages.dashboard.consent.status.disabled'),
  },
};

const newsletterStrings = {
  title: t('pages.dashboard.newsletter.title'),
  subscribed: t('pages.dashboard.newsletter.subscribed'),
  unsubscribed: t('pages.dashboard.newsletter.unsubscribed'),
  unsubscribe: t('pages.dashboard.newsletter.unsubscribe'),
  resubscribe: t('pages.dashboard.newsletter.resubscribe'),
  processing: t('pages.dashboard.newsletter.processing'),
  success: t('pages.dashboard.newsletter.success'),
  error: t('pages.dashboard.newsletter.error'),
};

// recent comments removed in Dashboard V2

// recommendations removed in Dashboard V2

const initialNewsletterSubscribed = true;

const accountI18nSettings = {
  upload: {
    invalid_type: t('common.upload.invalid_type'),
    too_large: t('common.upload.too_large'),
  },
  status: {
    uploading: t('common.status.uploading'),
  },
  actions: {
    upload: t('common.actions.upload'),
  },
  success: {
    avatar_updated: t('common.success.avatar_updated'),
  },
  errors: {
    upload_failed_prefix: t('common.errors.upload_failed_prefix'),
  },
};

const baseDashboardPath =
  locale === 'de' ? '/de/dashboard' : locale === 'en' ? '/en/dashboard' : '/dashboard';
const redirectUrl = locale === 'de' ? '/de/login' : locale === 'en' ? '/en/login' : '/login';
const billingUrl = `${baseDashboardPath}#billing`;
const authGuideHref =
  locale === 'en' ? 'https://hub-evolution.com/en/docs' : 'https://hub-evolution.com/docs';

const manageBillingLink = (() => {
  try {
    const u = new URL('/api/billing/portal', 'http://x');
    const cur = Astro.url;
    const currentPath = `${cur.pathname}${cur.search}`;
    if (currentPath.startsWith('/')) {
      u.searchParams.set('return_to', currentPath);
    }
    return u.pathname + u.search;
  } catch {
    return '/api/billing/portal';
  }
})();

// removed buyCreditsLink: direct checkout UI implemented inline

const dangerStrings = {
  title: t('pages.dashboard.account.danger.title'),
  description: t('pages.dashboard.account.danger.description'),
  button: t('pages.dashboard.account.danger.button'),
  close: t('pages.dashboard.account.danger.close'),
  confirm: {
    title: t('pages.dashboard.account.danger.confirm.title'),
    description: t('pages.dashboard.account.danger.confirm.description'),
    confirmCta: t('pages.dashboard.account.danger.confirm.confirmCta'),
    cancelCta: t('pages.dashboard.account.danger.confirm.cancelCta'),
  },
  subscription: {
    title: t('pages.dashboard.account.danger.subscription.title'),
    description: t('pages.dashboard.account.danger.subscription.description'),
    periodEnd: t('pages.dashboard.account.danger.subscription.periodEnd'),
    indefinite: t('pages.dashboard.account.danger.subscription.indefinite'),
    goToBilling: t('pages.dashboard.account.danger.subscription.goToBilling'),
    deleteAnyway: t('pages.dashboard.account.danger.subscription.deleteAnyway'),
    back: t('pages.dashboard.account.danger.subscription.back'),
  },
  messages: {
    processing: t('pages.dashboard.account.danger.messages.processing'),
    success: t('pages.dashboard.account.danger.messages.success'),
    error: t('pages.dashboard.account.danger.messages.error'),
  },
};

const profileCopy = {
  title: t('pages.dashboard.account.profile.title'),
  description: t('pages.dashboard.account.profile.description'),
  nameLabel: t('pages.dashboard.account.profile.nameLabel'),
  usernameLabel: t('pages.dashboard.account.profile.usernameLabel'),
  emailLabel: t('pages.dashboard.account.profile.emailLabel'),
  changeEmailHint: t('pages.dashboard.account.profile.changeEmailHint'),
  changeEmailCta: t('pages.dashboard.account.profile.changeEmailCta'),
  saveCta: t('pages.dashboard.account.profile.saveCta'),
  hybridTitle: t('pages.dashboard.account.profile.hybridTitle'),
  hybridDescription: t('pages.dashboard.account.profile.hybridDescription'),
  supportTitle: t('pages.dashboard.account.profile.supportTitle'),
  supportDescription: t('pages.dashboard.account.profile.supportDescription'),
  supportCta: t('pages.dashboard.account.profile.supportCta'),
  supportHref: authGuideHref,
};
---

<BaseLayout title={t('pages.dashboard.title') ?? 'Dashboard'}>
  <!-- Transparent background to match Landing look -->
  <div class="relative min-h-screen overflow-hidden">
    <div class="hidden"></div>
    <div class="hidden"></div>

    <div class="container mx-auto p-4 lg:p-6">
      <!-- Futuristic mosaic grid: free-flow cards with spans -->
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-12 xl:gap-6">
        <!-- Top row: Profile, Newsletter, Billing -->
        <div class="xl:col-span-4">
          <UserProfile user={{ ...user, plan: billingSummary?.plan ?? user.plan }} />
        </div>

        <div class="xl:col-span-4">
          <Card as="div" className="group p-4">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
              <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:gap-6">
                <div class="flex flex-col gap-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                    {billingStrings.credits}
                  </span>
                  <span class="text-lg font-bold text-white">
                    {
                      typeof billingSummary?.creditsRemaining === 'number'
                        ? billingSummary.creditsRemaining
                        : '—'
                    }
                  </span>
                </div>
                <div class="flex flex-col gap-1">
                  <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                    {t('pages.dashboard.billing.quota.label')}
                  </span>
                  <div class="flex items-baseline gap-2">
                    <span id="quota-remaining" class="text-lg font-bold text-white">
                      {
                        (() => {
                          const limit = Number(billingSummary?.monthlyLimit || 0);
                          const used = Number(billingSummary?.monthlyUsed || 0);
                          const rem = Math.max(0, limit - used);
                          return rem > 0 ? rem : '—';
                        })()
                      }
                    </span>
                    <span id="quota-loading" class="text-[10px] font-semibold text-slate-400">
                      {t('pages.dashboard.billing.quota.loading')}
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2 sm:self-end">
                <select
                  id="credits-pack"
                  class="rounded-md bg-white/10 text-white text-xs px-2 py-1 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  <option value="100">100</option>
                  <option value="500">500</option>
                  <option value="1500">1500</option>
                </select>
                <button
                  id="buy-credits-btn"
                  type="button"
                  data-login-href={redirectUrl}
                  data-error-prefix={buyCreditsStrings.errorPrefix}
                  data-error-invalid-response={buyCreditsStrings.errorInvalidResponse}
                  data-error-generic={buyCreditsStrings.errorGeneric}
                  class="inline-flex items-center rounded-md bg-gradient-to-r from-indigo-500 to-fuchsia-500 px-3 py-1.5 text-xs font-bold text-white shadow-sm shadow-indigo-500/30 transition hover:from-indigo-600 hover:to-fuchsia-600 disabled:opacity-60"
                >
                  {buyCreditsStrings.button}
                </button>
              </div>
            </div>
            {
              (() => {
                const limit = Number(billingSummary?.monthlyLimit || 0);
                const used = Number(billingSummary?.monthlyUsed || 0);
                const pct =
                  limit > 0 ? Math.min(100, Math.max(0, Math.round((used / limit) * 100))) : 0;
                const pe = Number(billingSummary?.periodEndsAt || 0);
                const daysLeft =
                  pe > 0 ? Math.max(0, Math.ceil((pe - Date.now()) / (1000 * 60 * 60 * 24))) : null;
                return (
                  <div class="mt-3 space-y-1.5">
                    <div class="h-2 w-full rounded-full bg-white/10 overflow-hidden">
                      <div
                        id="quota-progress"
                        class="h-2 bg-gradient-to-r from-emerald-500 to-teal-500"
                        style={`width: ${pct}%`}
                      />
                    </div>
                    <div class="flex items-center justify-between text-xs text-slate-400">
                      <span>
                        <span id="quota-used">{used}</span>/<span id="quota-limit">{limit}</span>{' '}
                        {t('pages.dashboard.billing.quota.usage.suffix')}
                      </span>
                      {daysLeft !== null && (
                        <span>
                          {t('pages.dashboard.billing.quota.resets', { count: daysLeft })}
                        </span>
                      )}
                    </div>
                  </div>
                );
              })()
            }
          </Card>
        </div>

        <div class="xl:col-span-4">
          <Card as="div" className="group p-4">
            <BillingCard
              client:load
              summary={billingSummary}
              strings={billingStrings}
              manageLink={manageBillingLink}
            />
          </Card>
        </div>

        <div class="xl:col-span-12">
          <Card as="div" className="group p-4">
            <ReferralCard client:load initialSummary={referralSummary} strings={referralStrings} />
          </Card>
        </div>

        <!-- Middle row: AccountSettings full width -->
        <div class="xl:col-span-12">
          <AccountSettingsSection
            user={user}
            planLabels={billingStrings.planLabels}
            billingUrl={billingUrl}
            redirectUrl={redirectUrl}
            dangerStrings={dangerStrings}
            profileCopy={profileCopy}
            i18nSettings={accountI18nSettings}
          />
        </div>

        <!-- Bottom row: Consent + Newsletter -->
        <div class="grid gap-6 xl:col-span-12 xl:gap-8">
          <ConsentPreferencesCard
            client:load
            strings={consentStrings}
            manageHref={localizePath(locale, consentStrings.manageHref)}
          />
          <NewsletterPreferencesCard
            client:load
            email={user.email}
            initiallySubscribed={initialNewsletterSubscribed}
            strings={newsletterStrings}
          />
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline nonce={Astro.locals.cspNonce}>
  (function () {
    try {
      fetch('/api/dashboard/billing-summary')
        .then((r) => (r.ok ? r.json() : Promise.reject(r)))
        .then((json) => {
          if (!json || typeof json !== 'object' || json === null) return;
          if (!('data' in json) || !json['data']) return;
          const data = json['data'];
          const limit = Number(data.monthlyLimit || 0);
          const used = Number(data.monthlyUsed || 0);
          const rem = Math.max(0, limit - used);
          const progress =
            limit > 0 ? Math.min(100, Math.max(0, Math.round((used / limit) * 100))) : 0;
          const elRem = document.getElementById('quota-remaining');
          if (elRem) elRem.textContent = rem > 0 ? String(rem) : '—';
          const elUsed = document.getElementById('quota-used');
          if (elUsed) elUsed.textContent = String(used);
          const elLimit = document.getElementById('quota-limit');
          if (elLimit) elLimit.textContent = String(limit);
          const bar = document.getElementById('quota-progress');
          if (bar && bar instanceof HTMLElement) bar.style.width = `${progress}%`;
          const elLoading = document.getElementById('quota-loading');
          if (elLoading && elLoading instanceof HTMLElement) elLoading.style.display = 'none';
        })
        .catch(() => {
          const elLoading = document.getElementById('quota-loading');
          if (elLoading && elLoading instanceof HTMLElement) elLoading.style.display = 'none';
        });
    } catch {}
  })();
</script>

<script is:inline nonce={Astro.locals.cspNonce}>
  (function () {
    try {
      var btn = document.getElementById('buy-credits-btn');
      var sel = document.getElementById('credits-pack');
      if (!btn || !sel) return;

      var loginHref = (btn && btn.getAttribute('data-login-href')) || '/login';
      var errorPrefix =
        (btn && btn.getAttribute('data-error-prefix')) || 'Checkout failed: ';
      var errorInvalidResponse =
        (btn && btn.getAttribute('data-error-invalid-response')) ||
        'Checkout failed: Invalid response';
      var errorGeneric =
        (btn && btn.getAttribute('data-error-generic')) || 'Checkout failed';

      function readCookie(name) {
        var m = document.cookie.match(
          new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()\[\]\\/+^]/g, '\\$&') + '=([^;]*)')
        );
        return m ? decodeURIComponent(m[1]) : null;
      }
      function ensureCsrfToken() {
        var token = readCookie('csrf_token');
        if (!token) {
          try {
            var buf = new Uint8Array(16);
            (globalThis.crypto || window.crypto).getRandomValues(buf);
            token = Array.from(buf)
              .map(function (b) {
                return b.toString(16).padStart(2, '0');
              })
              .join('');
            var attrs = ['Path=/', 'SameSite=Lax'];
            if (typeof location !== 'undefined' && location.protocol === 'https:')
              attrs.push('Secure');
            document.cookie = 'csrf_token=' + encodeURIComponent(token) + '; ' + attrs.join('; ');
          } catch {}
        }
        return token || '';
      }
      function getWorkspaceId() {
        try {
          var url = new URL(window.location.href);
          var ws = url.searchParams.get('ws');
          if (ws && ws.trim()) {
            localStorage.setItem('ws_id', ws);
            return ws;
          }
          var ls = localStorage.getItem('ws_id');
          if (ls && ls.trim()) return ls;
        } catch {}
        return 'default';
      }

      btn.addEventListener('click', function () {
        if (btn.disabled) return;
        (async function () {
          try {
            btn.disabled = true;
            var csrf = ensureCsrfToken();
            var pack = Number((sel && sel.value) || '100');
            var res = await fetch('/api/billing/credits', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf },
              credentials: 'include',
              body: JSON.stringify({
                pack: pack,
                workspaceId: getWorkspaceId(),
                returnTo: location.pathname + location.search,
              }),
            });
            if (res.status === 401) {
              window.location.href = loginHref;
              return;
            }
            if (!res.ok) {
              var text = await res.text().catch(function () {
                return '';
              });
              alert(errorPrefix + (text || res.status));
              return;
            }
            var data = await res.json().catch(function () {
              return {};
            });
            var nextUrl = (data && (data.url || (data.data && data.data.url))) || '';
            if (nextUrl) {
              window.location.href = nextUrl;
            } else {
              alert(errorInvalidResponse);
            }
          } catch (e) {
            console.warn('[credits] checkout error', e);
            alert(errorGeneric);
          } finally {
            btn.disabled = false;
          }
        })();
      });
    } catch {}
  })();
</script>
