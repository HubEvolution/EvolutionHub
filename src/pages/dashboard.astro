---
import BaseLayout from '../layouts/BaseLayout.astro';
import UserProfile from '../components/dashboard/UserProfile.astro';
import StatsCard from '../components/dashboard/StatsCard.astro';
import QuickActions from '../components/dashboard/QuickActions.astro';
import ProjectsPanel from '../components/dashboard/ProjectsPanel.astro';
import ActivityFeed from '../components/dashboard/ActivityFeed.astro';
import type { QuickAction } from '../types/dashboard';

const locals = Astro.locals as any;
if (!locals.user) {
  return Astro.redirect('/login');
}

const user = locals.user;

// Fetch data for the dashboard components
const db = locals.runtime.env.DB;

// Fetch projects, activities, and stats in parallel
const projectsStmt = db.prepare("SELECT * FROM projects WHERE user_id = ?").bind(user.id);
const activitiesStmt = db.prepare("SELECT * FROM activities WHERE user_id = ? ORDER BY created_at DESC LIMIT 10").bind(user.id);
const projectsCountStmt = db.prepare('SELECT count(*) as count FROM projects WHERE user_id = ?').bind(user.id);
const tasksCountStmt = db.prepare('SELECT count(*) as count FROM tasks WHERE user_id = ?').bind(user.id);
const teamMembersCountStmt = db.prepare('SELECT count(*) as count FROM users').bind(); // As per original logic

const [
    projectsResponse,
    activitiesResponse,
    projectsCountResult,
    tasksCountResult,
    teamMembersCountResult
] = await Promise.all([
    projectsStmt.all(),
    activitiesStmt.all(),
    projectsCountStmt.first(),
    tasksCountStmt.first(),
    teamMembersCountStmt.first()
]);

const projects = projectsResponse.results || [];
const activities = activitiesResponse.results || [];
const stats = {
  projects: projectsCountResult?.count || 0,
  tasks: tasksCountResult?.count || 0,
  teamMembers: teamMembersCountResult?.count || 0,
};

const quickActions: QuickAction[] = [
    { id: 'new-project', title: 'New Project', description: 'Start a new project', icon: '/icons/project.svg', action: 'create_project', variant: 'primary' },
    { id: 'new-task', title: 'New Task', description: 'Create a new task', icon: '/icons/task.svg', action: 'create_task', variant: 'success' },
    { id: 'invite-team', title: 'Invite Team', description: 'Invite a new team member', icon: '/icons/team.svg', action: 'invite_member', variant: 'secondary' },
    { id: 'view-docs', title: 'View Docs', description: 'Read the documentation', icon: '/icons/docs.svg', action: 'view_docs', variant: 'secondary' }
];
---

<BaseLayout title="Dashboard">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      
      <!-- Left Column -->
      <div class="lg:col-span-4 xl:col-span-3 flex flex-col gap-6">
        <UserProfile user={user} />
        <QuickActions actions={quickActions} />
      </div>

      <!-- Right Column -->
      <div class="lg:col-span-8 xl:col-span-9 flex flex-col gap-6">
        <StatsCard stats={stats} />
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
          <ProjectsPanel projects={projects} />
          <ActivityFeed activities={activities} />
        </div>
      </div>

    </div>
  </div>
</BaseLayout>
