---
import BaseLayout from '../layouts/BaseLayout.astro';
import UserProfile from '../components/dashboard/UserProfile.astro';
import StatsCard from '../components/dashboard/StatsCard.astro';
import QuickActions from '../components/dashboard/QuickActions.astro';
import ProjectsPanel from '../components/dashboard/ProjectsPanel.astro';
import ActivityFeed from '../components/dashboard/ActivityFeed.astro';
import type { QuickAction } from '../types/dashboard';

if (!Astro.locals.user) {
  return Astro.redirect('/login');
}

const user = Astro.locals.user;

// Fetch data for the dashboard components
const db = Astro.locals.runtime.env.DB;
const projectsResponse = await db.prepare("SELECT * FROM projects WHERE user_id = ?").bind(user.id).all();
const activitiesResponse = await db.prepare("SELECT * FROM activities WHERE user_id = ? ORDER BY created_at DESC LIMIT 10").bind(user.id).all();

const projects = projectsResponse.results || [];
const activities = activitiesResponse.results || [];

const quickActions: QuickAction[] = [
    { id: 'new-project', title: 'New Project', description: 'Start a new project', icon: 'ðŸš€', action: 'create_project', variant: 'primary' },
    { id: 'new-task', title: 'New Task', description: 'Create a new task', icon: 'âœ…', action: 'create_task', variant: 'success' },
    { id: 'invite-team', title: 'Invite Team', description: 'Invite a new team member', icon: 'ðŸ‘¥', action: 'invite_member', variant: 'secondary' },
    { id: 'view-docs', title: 'View Docs', description: 'Read the documentation', icon: 'ðŸ“š', action: 'view_docs', variant: 'secondary' }
];
---

<BaseLayout title="Dashboard">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-1 space-y-8">
        <UserProfile user={user} />
        <QuickActions actions={quickActions} />
      </div>
      <div class="lg:col-span-2 space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <StatsCard title="Projects" value={projects.length} change="+5%" />
          <StatsCard title="Tasks" value="8" change="-2%" />
          <StatsCard title="Team Members" value="4" />
        </div>
        <ProjectsPanel projects={projects} />
        <ActivityFeed activities={activities} />
      </div>
    </div>
  </div>
</BaseLayout>
