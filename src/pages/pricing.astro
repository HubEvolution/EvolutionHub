---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PricingTable from '@/components/pricing/PricingTable.astro';
import FeatureComparison from '@/components/pricing/FeatureComparison.astro';
import { getI18n, getI18nArray } from '@/utils/i18n';
import { getLocale } from '@/lib/i18n';
import { localizePath } from '@/lib/locale-path';
import Card from '@/components/ui/Card';
import Button from '@/components/ui/Button.astro';

// Set page metadata
const locale = getLocale(Astro.url.pathname);
const t = getI18n(locale);
const ta = getI18nArray(locale);
const title =
  locale === 'en'
    ? 'Plans & pricing: credits, monthly plans & starter packages'
    : t('pages.pricing.title');
const description =
  locale === 'en'
    ? 'Pay-as-you-go credits or monthly subscriptions. Flexible scaling from hobby to enterprise. Compare plans & features.'
    : t('pages.pricing.description');
const billingReason = Astro.url.searchParams.get('billing');
const billingMessage = (() => {
  switch (billingReason) {
    case 'unauthorized':
      return 'Please sign in to access your billing portal.';
    case 'stripe_not_configured':
      return 'Billing portal is not available at the moment.';
    case 'db_unavailable':
      return 'We could not reach the billing service. Please try again later.';
    case 'no_customer':
      return 'No Stripe customer is linked to your account yet.';
    case 'portal_unavailable':
    case 'portal_error':
      return 'We could not open your billing portal. Please try again.';
    default:
      return null;
  }
})();

interface CreditPack {
  id: number;
  title: string;
  price: string;
  description: string;
  bullets: string[];
  cta: string;
  buttonVariant: 'primary' | 'secondary' | 'outline' | 'ghost' | 'link' | 'accent';
}

const sanitize = (value: string | null | undefined) => {
  if (!value) return '';
  const trimmed = value.trim();
  if (!trimmed) return '';
  if (trimmed.startsWith('[') && trimmed.endsWith(']')) return '';
  if (/fallback_not_found/i.test(trimmed)) return '';
  return trimmed;
};

const creditDetailsLabel = sanitize(t('pages.pricing.credits_packs.details.trigger')) || 'Details';

const creditPacks: CreditPack[] = [
  {
    id: 100,
    title: t('pages.pricing.credits_packs.cards.100.title') || '100 credits',
    price: t('pages.pricing.credits_packs.cards.100.price') || '€6.00',
    description:
      t('pages.pricing.credits_packs.cards.100.description') ||
      'Perfect for quick experiments or occasional enhancements.',
    bullets: ta('pages.pricing.credits_packs.cards.100.bullets') || [],
    cta: t('pages.pricing.credits_packs.cards.100.cta') || 'Buy 100 credits',
    buttonVariant: 'secondary',
  },
  {
    id: 500,
    title: t('pages.pricing.credits_packs.cards.500.title') || '500 credits',
    price: t('pages.pricing.credits_packs.cards.500.price') || '€22.00',
    description:
      t('pages.pricing.credits_packs.cards.500.description') ||
      'Great for active creators running weekly jobs.',
    bullets: ta('pages.pricing.credits_packs.cards.500.bullets') || [],
    cta: t('pages.pricing.credits_packs.cards.500.cta') || 'Buy 500 credits',
    buttonVariant: 'primary',
  },
  {
    id: 1500,
    title: t('pages.pricing.credits_packs.cards.1500.title') || '1500 credits',
    price: t('pages.pricing.credits_packs.cards.1500.price') || '€55.00',
    description:
      t('pages.pricing.credits_packs.cards.1500.description') ||
      'Best for production-scale batches and agency workloads.',
    bullets: ta('pages.pricing.credits_packs.cards.1500.bullets') || [],
    cta: t('pages.pricing.credits_packs.cards.1500.cta') || 'Buy 1500 credits',
    buttonVariant: 'accent',
  },
];
const retryHref = (() => {
  try {
    const u = new URL('/api/billing/portal', 'http://x');
    const cur = Astro.url;
    const current = `${cur.pathname}${cur.search}`;
    if (current.startsWith('/')) u.searchParams.set('return_to', current);
    return u.pathname + u.search;
  } catch {
    return '/api/billing/portal';
  }
})();
---

<BaseLayout title={title} description={description} comingSoon={false}>
  <main class="min-h-screen bg-transparent py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      {
        billingMessage && (
          <div
            role="alert"
            class="mb-4 rounded-xl border border-amber-400/30 bg-amber-50 text-amber-900 dark:bg-amber-500/10 dark:text-amber-200 px-4 py-3"
          >
            <div class="flex items-center justify-between gap-3">
              <p class="text-sm">{billingMessage}</p>
              <a
                href={retryHref}
                class="inline-flex items-center rounded-md border border-amber-400/40 bg-amber-500/10 px-2.5 py-1 text-xs font-semibold text-amber-900 dark:text-amber-200 hover:bg-amber-500/20"
              >
                Try again
              </a>
            </div>
          </div>
        )
      }
      <div class="text-center">
        <h1
          class="text-4xl font-extrabold tracking-tight text-gray-900 dark:text-white sm:text-5xl md:text-6xl"
        >
          {t('pages.pricing.header.title')}
        </h1>
        <p class="mt-4 max-w-3xl mx-auto text-xl text-gray-500 dark:text-gray-300">
          {t('pages.pricing.header.subtitle')}
        </p>
      </div>

      <nav
        class="mt-4 flex items-center justify-center gap-6 text-sm text-gray-500 dark:text-gray-400"
      >
        <a href="#plans" class="hover:text-gray-900 dark:hover:text-gray-200"
          >{t('pages.pricing.sections.plans') || 'Plans'}</a
        >
        <span aria-hidden>·</span>
        <a href="#credit-packs" class="hover:text-gray-900 dark:hover:text-gray-200"
          >{t('pages.pricing.sections.credits_packs') || 'Credit packs'}</a
        >
        <span aria-hidden>·</span>
        <a href="#comparison" class="hover:text-gray-900 dark:hover:text-gray-200"
          >{t('pages.pricing.sections.comparison') || 'Comparison'}</a
        >
        <span aria-hidden>·</span>
        <a href="#faq" class="hover:text-gray-900 dark:hover:text-gray-200"
          >{t('pages.pricing.sections.faq') || 'FAQ'}</a
        >
      </nav>

      <div class="mt-8 mx-auto flex items-center justify-center text-center">
        <div
          class="inline-flex rounded-full bg-gradient-to-br from-primary-500/15 via-primary-500/10 to-secondary-500/15 p-1 shadow-[0_10px_30px_-20px_rgba(6,182,212,0.75)] ring-1 ring-primary-500/40"
          role="tablist"
          aria-label="Billing interval"
        >
          <button
            id="interval-monthly"
            class="min-w-[100px] px-3 py-1.5 text-sm rounded-full transition-all duration-200 ease-out scale-95 text-primary-100 bg-gradient-to-r from-primary-500/0 via-primary-500/0 to-secondary-500/0 data-[active='1']:from-primary-500 data-[active='1']:via-primary-400 data-[active='1']:to-secondary-500 data-[active='1']:text-white data-[active='1']:shadow-[0_10px_25px_-15px_rgba(6,182,212,0.9)] data-[active='1']:scale-100 data-[active='1']:font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-300/70"
            data-active="1"
            aria-pressed="true"
            type="button">{t('pages.pricing.interval.monthly') || 'Monthly'}</button
          >
          <button
            id="interval-annual"
            class="min-w-[100px] px-3 py-1.5 text-sm rounded-full transition-all duration-200 ease-out scale-95 text-primary-100 bg-gradient-to-r from-primary-500/0 via-primary-500/0 to-secondary-500/0 data-[active='1']:from-primary-500 data-[active='1']:via-primary-400 data-[active='1']:to-secondary-500 data-[active='1']:text-white data-[active='1']:shadow-[0_10px_25px_-15px_rgba(6,182,212,0.9)] data-[active='1']:scale-100 data-[active='1']:font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-300/70"
            data-active="0"
            aria-pressed="false"
            type="button">{t('pages.pricing.interval.annual') || 'Annual'}</button
          >
        </div>
      </div>

      <section id="plans" class="scroll-mt-24 mt-6 md:mt-8">
        <PricingTable />
      </section>

      <section id="credit-packs" class="mt-8" aria-labelledby="credit-packs-heading">
        <div class="mb-6 text-center">
          <h2 id="credit-packs-heading" class="text-2xl font-bold text-gray-900 dark:text-white">
            {t('pages.pricing.credits_packs.title') || 'Buy extra credits'}
          </h2>
          <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
            {
              t('pages.pricing.credits_packs.subtitle') ||
                'One-time packs to top up your monthly quota.'
            }
          </p>
        </div>

        <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
          {
            creditPacks.map((pack: CreditPack) => (
              <Card variant="holo" className="relative flex h-full flex-col rounded-2xl p-6">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{pack.title}</h3>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">{pack.description}</p>

                <div class="mt-6 flex items-baseline gap-2">
                  <span class="text-3xl font-bold text-gray-900 dark:text-white">{pack.price}</span>
                  <span class="text-sm text-gray-500 dark:text-gray-400">one-time</span>
                </div>

                {pack.bullets.length > 0 && (
                  <ul class="mt-6 space-y-2 text-sm text-gray-700 dark:text-gray-200">
                    {pack.bullets.map((bullet: string) => (
                      <li class="flex items-start gap-2">
                        <svg
                          class="mt-0.5 h-4 w-4 flex-none text-emerald-500"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <path d="M5 13l4 4L19 7" />
                        </svg>
                        <span>{bullet}</span>
                      </li>
                    ))}
                  </ul>
                )}

                <Button
                  id={`buy-credits-${pack.id}`}
                  type="button"
                  variant={pack.buttonVariant}
                  size="md"
                  className="mt-8"
                >
                  {pack.cta}
                </Button>

                <button
                  type="button"
                  class="mt-4 inline-flex items-center gap-2 text-sm font-medium text-primary-200 transition hover:text-primary-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-400"
                  data-pricing-detail-trigger
                  data-pricing-detail-kind="credit"
                  data-pricing-detail-id={String(pack.id)}
                  aria-haspopup="dialog"
                >
                  {creditDetailsLabel}
                  <svg
                    class="h-4 w-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <path d="m9 5 7 7-7 7" />
                  </svg>
                </button>
              </Card>
            ))
          }
        </div>
      </section>

      <section class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4" aria-label="Highlights">
        <Card variant="holo" className="p-4 rounded-2xl">
          <h3 class="font-semibold text-gray-900 dark:text-white">
            {t('pages.pricing.highlights.tools_title') || 'All 5 tools included'}
          </h3>
          <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
            {
              t('pages.pricing.highlights.tools_desc') ||
                'Use Imag‑Enhancer, Video Enhancer, Prompt Enhancer, Voice Transcriptor, Webscraper'
            }
          </p>
        </Card>
        <Card variant="holo" className="p-4 rounded-2xl">
          <h3 class="font-semibold text-gray-900 dark:text-white">
            {t('pages.pricing.highlights.commercial_title') || 'Commercial use allowed'}
          </h3>
          <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
            {
              t('pages.pricing.highlights.commercial_desc') ||
                'Pro, Business, and Enterprise include commercial usage rights'
            }
          </p>
        </Card>
        <Card variant="holo" className="p-4 rounded-2xl">
          <h3 class="font-semibold text-gray-900 dark:text-white">
            {t('pages.pricing.highlights.credits_title') || 'Monthly credits + daily burst'}
          </h3>
          <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
            {
              t('pages.pricing.highlights.credits_desc') ||
                'Monthly resets with fair daily burst caps'
            }
          </p>
        </Card>
      </section>

      <section id="comparison" class="mt-12 scroll-mt-24">
        <FeatureComparison />
      </section>

      <Card as="section" variant="holo" className="mt-12 rounded-2xl p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">
          {t('pages.pricing.credits_explainer.title')}
        </h2>
        <p class="mt-2 text-gray-600 dark:text-gray-300">
          {t('pages.pricing.credits_explainer.intro')}
        </p>
        <ul class="mt-4 list-disc pl-6 text-gray-700 dark:text-gray-200 space-y-1">
          <li>{t('pages.pricing.credits_explainer.bullets.0')}</li>
          <li>{t('pages.pricing.credits_explainer.bullets.1')}</li>
          <li>{t('pages.pricing.credits_explainer.bullets.2')}</li>
        </ul>
      </Card>

      <Card as="div" variant="holo" id="faq" className="mt-16 rounded-2xl p-8 scroll-mt-24">
        <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">
          {t('pages.pricing.faq.title')}
        </h2>

        <div class="space-y-6 mt-8">
          <div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
              {t('pages.pricing.faq.question1')}
            </h3>
            <p class="mt-2 text-gray-600 dark:text-gray-300">
              {t('pages.pricing.faq.answer1')}
            </p>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
              {t('pages.pricing.faq.question2')}
            </h3>
            <p class="mt-2 text-gray-600 dark:text-gray-300">
              {t('pages.pricing.faq.answer2')}
            </p>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
              {t('pages.pricing.faq.question3')}
            </h3>
            <p class="mt-2 text-gray-600 dark:text-gray-300">
              {t('pages.pricing.faq.answer3')}
            </p>
          </div>
        </div>

        <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
          <p class="text-center">
            {t('pages.pricing.faq_contact_cta_text')}
            <a
              href={localizePath(locale, '/kontakt')}
              class="text-blue-600 dark:text-blue-400 hover:underline"
              >{t('pages.pricing.faq_contact_cta_link_text')}</a
            >
          </p>
        </div>
      </Card>
    </div>
  </main>
</BaseLayout>
