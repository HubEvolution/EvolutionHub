---
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}
// Prerender deaktiviert, da Astro.request.headers in statischem Modus nicht verfügbar ist
export const prerender = false;
// Import BaseLayout using a relative path to resolve the alias issue
import BaseLayout from '../../layouts/BaseLayout.astro';
// Correctly import the blogService instance and the BlogCollectionEntry type
import { blogService, type BlogCollectionEntry } from '../../lib/blog';
import BlogPostComponent from '../../components/BlogPost.astro';
import type { ProcessedBlogPost } from '../../content/types';
// Commented out CommentSection as it was removed earlier
// import CommentSection from '../../components/comments/CommentSection.astro';

// Get slug from URL
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Try to load the blog post
let postData: ProcessedBlogPost | null = null;
let originalEntry: BlogCollectionEntry | null = null; // Use the imported BlogCollectionEntry type
try {
  // Use the imported blogService instance directly
  const result = await blogService.getPostBySlug(slug);
  if (result) {
    // Assuming getPostBySlug returns an object with 'entry' and 'processedData'
    originalEntry = result.entry;
    postData = result.processedData; // Use processed data for component props
  }
} catch (error) {
  console.error('Error loading blog post:', error);
  // Redirect to 404 if there's an error loading the post
  return Astro.redirect('/404');
}

// If no post data or original entry found, redirect to 404
if (!postData || !originalEntry) {
  return Astro.redirect('/404');
}

// Use the render method from the original entry
const { Content } = await originalEntry.render();

// Load related posts (based on tags and category)
let relatedPosts: ProcessedBlogPost[] = [];

if (postData) { // Check processed data for consistency
  try {
    // Pass the original entry to getRelatedPosts for relation logic
    const related = await blogService.getRelatedPosts(
      originalEntry, // Pass the original entry object
      {
      limit: 3,
      includeDrafts: import.meta.env.DEV
    });

    // Ensure we have an array and filter out any invalid posts
    if (Array.isArray(related)) {
      relatedPosts = related.filter((p): p is ProcessedBlogPost =>
        // Robust check for valid processed post structure
        p && typeof p === 'object' && typeof p.data === 'object' && p.data !== null && 'title' in p.data
      );
    }
  } catch (error) {
    console.error('Fehler beim Laden verwandter Beiträge:', error);
    relatedPosts = [];
  }
}

// SEO Metadaten
const title = postData.data.title;
const description = postData.data.description || '';
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
// Ensure imageUrl is correctly formed
const imageUrl = postData.data.image?.src
  ? new URL(postData.data.image.src, Astro.site).toString()
  : new URL('/images/blog/default-og.jpg', Astro.site).toString();

// Refactored logic for dateModified
const datePublishedISO = new Date(postData.data.pubDate).toISOString();
const dateModifiedISO = postData.data.updatedDate
  ? new Date(postData.data.updatedDate).toISOString()
  : datePublishedISO; // Use publishedDate if updatedDate is missing

// Strukturierte Daten für SEO (Schema.org)
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: imageUrl,
  author: {
    '@type': 'Person',
    name: Array.isArray(postData.data.author) ? postData.data.author[0] : postData.data.author?.name || 'EvolutionHub Team',
    url: 'https://evolution-hub.de/team' // Placeholder URL, adjust if specific author URLs exist
  },
  publisher: {
    '@type': 'Organization',
    name: 'EvolutionHub',
    logo: {
      '@type': 'ImageObject',
      url: new URL('/images/logo.png', Astro.site).toString()
    }
  },
  datePublished: datePublishedISO,
  dateModified: dateModifiedISO,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl.toString()
  }
};
---

<BaseLayout 
  title={title}
  description={description}
  canonical={canonicalUrl.toString()}
  structuredData={structuredData}
  image={imageUrl}
  type="article"
  publishedTime={datePublishedISO}
  modifiedTime={dateModifiedISO}
  author={Array.isArray(postData.data.author) ? postData.data.author[0] : postData.data.author?.name || 'EvolutionHub Team'}
  section={postData.data.category}
  tags={postData.data.tags}
>
  <article class="bg-white dark:bg-gray-900 py-12 sm:py-16">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <div class="mx-auto max-w-3xl">
        {/* Blog-Post-Komponente rendern */}
        <BlogPostComponent post={postData} relatedPosts={relatedPosts}>
          <Content />
        </BlogPostComponent>

        {/* Kommentarbereich */}
        {/* CommentSection is removed as per earlier user instructions */}
        {/* <CommentSection postId={post.slug} /> */}
      </div>
    </div>
  </article>

  {/* Newsletter-Anmeldung */}
  <div class="bg-gray-50 dark:bg-gray-800 py-16">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <div class="mx-auto max-w-2xl text-center">
        <h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-3xl">
          Bleiben Sie auf dem Laufenden
        </h2>
        <p class="mx-auto mt-4 max-w-xl text-gray-600 dark:text-gray-300">
          Abonnieren Sie unseren Newsletter, um über neue Artikel, Tipps und Neuigkeiten informiert zu werden.
        </p>
        <form class="mt-8 sm:mx-auto sm:flex sm:max-w-lg">
          <div class="min-w-0 flex-1">
            <label for="email" class="sr-only">E-Mail-Adresse</label>
            <input
              id="email"
              type="email"
              placeholder="Ihre E-Mail-Adresse"
              class="block w-full rounded-md border-0 px-4 py-3 text-base text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
              required
            />
          </div>
          <div class="mt-4 sm:mt-0 sm:ml-3">
            <button
              type="submit"
              class="block w-full rounded-md bg-emerald-600 px-6 py-3 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
            >
              Jetzt anmelden
            </button>
          </div>
        </form>
        <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">
          Wir geben Ihre Daten nicht weiter. Sie können sich jederzeit wieder abmelden.
        </p>
      </div>
    </div>
  </div>

  <script is:inline>
    // Verbessere die Lesbarkeit für lange Artikel
    document.addEventListener('DOMContentLoaded', () => {
      // Füge Lazy Loading für Bilder im Beitrag hinzu
      const images = document.querySelectorAll('article img:not([loading])');
      images.forEach(img => {
        img.loading = 'lazy';
      });

      // Füge Smooth Scrolling für interne Links hinzu
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          if (targetId === '#') return;

          const targetElement = document.querySelector(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });

            // Füge den Hash zur URL hinzu, ohne die Seite neu zu laden
            history.pushState(null, '', targetId);
          }
        });
      });

      // Aktiviere Tooltips für Fußnoten
      const footnotes = document.querySelectorAll('a[href^="#fn"], a[href^="#ref"]');
      footnotes.forEach(fn => {
        fn.setAttribute('data-tooltip', 'Zum entsprechenden Absatz springen');
        fn.classList.add('underline', 'decoration-dotted', 'decoration-gray-400', 'underline-offset-4');
      });
    });
  </script>
</BaseLayout>
