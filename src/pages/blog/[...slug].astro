---
// SSG + ISR aktivieren (Phase 2.1)
export const prerender = false;
export const revalidate = 300; // Sekunden
// Import BaseLayout using a relative path.
import BaseLayout from '@/layouts/BaseLayout.astro';
import { blogService } from '@/lib/blog';
import type { ContentfulBlogEntry as BlogCollectionEntry } from '@/lib/contentful';
import BlogPostComponent from '@/components/BlogPost.astro';
import type { ProcessedBlogPost } from '../../content/types';
import { CommentSection } from '@/components/comments/CommentSection';
import AosWrapper from '@/components/AosWrapper.astro';
import { getAlternateUrls } from '@/lib/seo';
import { getLocale } from '@/lib/i18n';

// Get slug from URL parameters (catch-all -> array of segments)
const slugParamRaw = (Astro.params as Record<string, unknown>)?.slug;
const slugParam = Array.isArray(slugParamRaw)
  ? slugParamRaw.join('/')
  : typeof slugParamRaw === 'string'
    ? slugParamRaw
    : undefined;

if (!slugParam) {
  // It's better to return a 404 response directly if slug is missing.
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Load user session for comment system
const user =
  (
    Astro.locals as
      | {
          user?: { id?: string | number; name?: string; email?: string; image?: string } | null;
        }
      | undefined
  )?.user ?? null;
const initialUser =
  user && typeof user === 'object' && user.name && user.email
    ? {
        id: String(user.id),
        name: String(user.name),
        email: String(user.email),
        image: user.image,
      }
    : null;

// Try to load the blog post
let postData: ProcessedBlogPost | null = null;
// To satisfy TypeScript, originalEntry should be typed as CollectionEntry<'blog'>.
// We are importing this type from '../../lib/blog' as `BlogCollectionEntry` for this purpose.
let originalEntry: BlogCollectionEntry | null = null;
try {
  // Use the imported blogService instance directly.
  // This call expects getPostBySlug in lib/blog.ts to return an object with 'entry' (of type BlogCollectionEntry) and 'processedData'.
  const result = await blogService.getPostBySlug(slugParam);
  if (result) {
    originalEntry = result.entry;
    postData = result.processedData; // Use processed data for component props
  }
} catch (error) {
  console.error('Error loading blog post:', error);
  // Redirect to 404 if there's an error loading the post
  return Astro.redirect('/404');
}

// If no post data or original entry found, redirect to 404
if (!postData || !originalEntry) {
  // This check is important to ensure we have valid data before rendering.
  // If `getPostBySlug` returns undefined, we should redirect to a 404 page.
  return Astro.redirect('/404');
}

// Contentful Rich Text wird bereits im BlogService zu bodyHtml verarbeitet (sanitised).

// Load related posts (based on tags and category)
// Initialize relatedPosts to an empty array to prevent potential errors if fetching fails.
let relatedPosts: ProcessedBlogPost[] = [];

// Check if postData is available before attempting to load related posts.
if (postData) {
  try {
    // Fetch related posts, ensuring originalEntry is non-null.
    // Using a non-null assertion `!` for originalEntry, as it's checked above.
    const related = await blogService.getRelatedPosts(slugParam, {
      limit: 3,
      includeDrafts: import.meta.env.DEV,
    });

    // Process the related posts if the fetch was successful and returned an array.
    if (Array.isArray(related)) {
      // Filter the related posts to ensure they conform to ProcessedBlogPost structure.
      relatedPosts = related.filter(
        (p): p is ProcessedBlogPost =>
          // Robust check for valid processed post structure
          p &&
          typeof p === 'object' &&
          typeof p.data === 'object' &&
          p.data !== null &&
          'title' in p.data
      );
    }
  } catch (error) {
    // Log any errors during related post fetching and default to an empty array.
    console.error('Fehler beim Laden verwandter Beiträge:', error);
    relatedPosts = []; // Ensure relatedPosts is an empty array in case of error.
  }
}

// SEO Metadaten
const data = postData.data as import('../../content/types').BlogPostData;
const authorName = Array.isArray(data.author)
  ? String((data.author as unknown[])[0] ?? 'EvolutionHub Team')
  : typeof data.author === 'object' &&
      data.author &&
      'name' in (data.author as unknown as Record<string, unknown>)
    ? String((data.author as { name?: unknown }).name)
    : typeof data.author === 'string'
      ? data.author
      : 'EvolutionHub Team';
const title = String(data.title);
const description = String(data.description || '');
const siteBase: URL = (Astro.site as URL) || new URL('http://127.0.0.1:8787');
const canonicalAlternates = getAlternateUrls(Astro.url.pathname);
const canonicalPath =
  getLocale(Astro.url.pathname) === 'en' ? canonicalAlternates.en : canonicalAlternates.de;
const canonicalUrl = new URL(canonicalPath, siteBase);
// Ensure imageUrl is correctly formed
const imageSrc =
  data.image && typeof (data.image as { src?: unknown }).src === 'string'
    ? (data.image as { src: string }).src
    : '/images/blog/default-og.jpg';
const imageUrl = new URL(imageSrc, siteBase).toString();

// Refactored logic for dateModified
const datePublishedISO =
  data.pubDate instanceof Date
    ? data.pubDate.toISOString()
    : new Date(String(data.pubDate)).toISOString();
const dateModifiedISO =
  data.updatedDate instanceof Date
    ? data.updatedDate.toISOString()
    : data.updatedDate
      ? new Date(String(data.updatedDate)).toISOString()
      : datePublishedISO;

// Strukturierte Daten für SEO (Schema.org)
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: imageUrl,
  author: {
    '@type': 'Person',
    name: authorName,
    url: 'https://evolution-hub.de/team', // Placeholder URL, adjust if specific author URLs exist
  },
  publisher: {
    '@type': 'Organization',
    name: 'EvolutionHub',
    logo: {
      '@type': 'ImageObject',
      url: new URL('/images/logo.png', siteBase).toString(),
    },
  },
  datePublished: datePublishedISO,
  dateModified: dateModifiedISO,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl.toString(),
  },
};
// Blog-Enhancements werden importfrei inline initialisiert (kein Astro.resolve)
// Static paths für SSG generieren
export async function getStaticPaths() {
  const { posts } = await blogService.getBlogIndexData(1, 500, {});
  return posts.map((post) => ({ params: { slug: String(post.slug) } }));
}
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonicalUrl.toString()}
  structuredData={structuredData}
  image={imageUrl}
  type="article"
  publishedTime={datePublishedISO}
  modifiedTime={dateModifiedISO}
  author={authorName}
  section={data.category}
  tags={data.tags}
>
  <article class="bg-white dark:bg-gray-900 py-12 sm:py-16" data-slug={slugParam}>
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <AosWrapper class="mx-auto max-w-3xl">
        {/* Blog-Post-Komponente mit Kommentarsektion im Slot */}
        <BlogPostComponent post={postData} relatedPosts={relatedPosts}>
          {
            postData.bodyHtml ? (
              <div set:html={postData.bodyHtml} />
            ) : (
              <p class="text-gray-600 dark:text-gray-300">
                Dieser Beitrag steht momentan nicht zur Verfügung.
              </p>
            )
          }
          <CommentSection
            slot="comments"
            entityType="blog_post"
            entityId={slugParam}
            initialUser={initialUser}
            client:load
          />
        </BlogPostComponent>
      </AosWrapper>
    </div>
  </article>

  {/* Newsletter-Anmeldung */}
  <div class="bg-gray-50 dark:bg-gray-800 py-16">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <div class="mx-auto max-w-2xl text-center">
        <AosWrapper
          tag="h2"
          duration={650}
          class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-3xl"
        >
          Bleiben Sie auf dem Laufenden
        </AosWrapper>
        <AosWrapper
          tag="p"
          delay={100}
          duration={650}
          class="mx-auto mt-4 max-w-xl text-gray-600 dark:text-gray-300"
        >
          Abonnieren Sie unseren Newsletter, um über neue Artikel, Tipps und Neuigkeiten informiert
          zu werden.
        </AosWrapper>
        <AosWrapper
          tag="form"
          delay={150}
          duration={650}
          class="mt-8 sm:mx-auto sm:flex sm:max-w-lg"
        >
          <div class="min-w-0 flex-1">
            <label for="email" class="sr-only">E-Mail-Adresse</label>
            <input
              id="email"
              type="email"
              placeholder="Ihre E-Mail-Adresse"
              class="block w-full rounded-md border-0 px-4 py-3 text-base text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
              required
            />
          </div>
          <div class="mt-4 sm:mt-0 sm:ml-3">
            <button
              type="submit"
              class="block w-full rounded-md bg-emerald-600 px-6 py-3 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
            >
              Jetzt anmelden
            </button>
          </div>
        </AosWrapper>
        <AosWrapper
          tag="p"
          delay={250}
          duration={600}
          class="mt-3 text-sm text-gray-500 dark:text-gray-400"
        >
          Wir geben Ihre Daten nicht weiter. Sie können sich jederzeit wieder abmelden.
        </AosWrapper>
      </div>
    </div>
  </div>
  <script is:inline nonce={Astro.locals.cspNonce}>
    (function () {
      'use strict';

      // Idempotenz-Flag
      let initialized = false;

      function enhanceLazyImages() {
        try {
          const images = document.querySelectorAll('article img:not([loading])');
          images.forEach((img) => {
            if ('loading' in img) {
              img.loading = 'lazy';
            }
            img.setAttribute('loading', 'lazy');
          });
        } catch (err) {
          try {
            console.warn('[BlogEnhancements] enhanceLazyImages failed', err);
          } catch (_) {}
        }
      }

      function enhanceFootnotes() {
        try {
          const footnotes = document.querySelectorAll('a[href^="#fn"], a[href^="#ref"]');
          footnotes.forEach((a) => {
            if (a.hasAttribute('data-footnote-enhanced')) return;
            a.setAttribute('data-footnote-enhanced', 'true');
            a.setAttribute('data-tooltip', 'Zum entsprechenden Absatz springen');
            a.classList.add(
              'underline',
              'decoration-dotted',
              'decoration-gray-400',
              'underline-offset-4'
            );
          });
        } catch (err) {
          try {
            console.warn('[BlogEnhancements] enhanceFootnotes failed', err);
          } catch (_) {}
        }
      }

      function init() {
        if (initialized) return;
        if (typeof document === 'undefined') return;
        enhanceLazyImages();
        enhanceFootnotes();
        initialized = true;

        // Increment page view counter (same-origin POST) with 12h per-browser throttle
        try {
          const root = document.querySelector('article[data-slug]');
          const slug = root ? root.getAttribute('data-slug') || '' : '';
          const key = `pv:${slug}`;
          const now = Date.now();
          const last = Number(localStorage.getItem(key) || '0');
          const TWELVE_HOURS = 12 * 60 * 60 * 1000;
          if (!last || now - last > TWELVE_HOURS) {
            const payload = { slug };
            fetch('/api/analytics/views', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            })
              .then(() => {
                try {
                  localStorage.setItem(key, String(now));
                } catch {}
              })
              .catch(() => {});
          }
        } catch (_) {}
      }

      function cleanup() {
        if (!initialized) return;
        initialized = false;
      }

      // Global für externes Cleanup verfügbar machen
      window.blogPostEnhancementsCleanup = cleanup;

      // DOM ready
      const start = () => init();
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', start);
      } else {
        start();
      }

      // SPA-Navigation über Astro Events
      document.addEventListener('astro:page-load', () => {
        initialized = false;
        init();
      });

      // Cleanup vor Seitenwechsel
      window.addEventListener('beforeunload', () => {
        try {
          cleanup();
        } catch (_) {}
      });
    })();
  </script>
</BaseLayout>
