---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ToolCard from '@/components/tools/ToolCard.astro';
import ToolFilter from '@/components/tools/ToolFilter.astro';
import { localizePath } from '@/lib/locale-path';
import { getLocale } from '@/lib/i18n';
import { getI18n } from '@/utils/i18n';
import { getAllTools, getToolCategories, type ToolCategory } from '@/lib/tools-data';
import Card from '@/components/ui/Card';
import { isToolsFilterEnabled } from '@/utils/feature-flags';
import ToolsIndexIsland from '@/components/tools/ToolsIndexIsland';
import { isToolVisible } from '@/lib/tools-availability';

// Get search params for filtering
const searchParams = Astro.url.searchParams;
const activeCategory = (searchParams.get('category') as ToolCategory) || 'all';
const searchQuery = searchParams.get('q') || '';
const locale = getLocale(Astro.url.pathname);
const t = getI18n(locale);
const allTools = getAllTools(locale);

// Filter tools based on category and search query
const filteredTools = allTools.filter((tool) => {
  const matchesCategory = activeCategory === 'all' || tool.category.includes(activeCategory);
  const matchesSearch =
    tool.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    tool.description.toLowerCase().includes(searchQuery.toLowerCase());
  return matchesCategory && matchesSearch;
});

const runtimeEnv = (Astro.locals && Astro.locals.runtime && Astro.locals.runtime.env) || undefined;

function flagOn(raw: string | undefined): boolean {
  if (raw === undefined || raw === null) return true;
  const v = String(raw).toLowerCase().trim();
  return !(v === '0' || v === 'false' || v === 'off' || v === 'no');
}

// Hidden placeholders should not render cards. Zusätzlich werden Tools mit
// Status `incubating`/`deprecated` für Endkund:innen in Production vollständig ausgeblendet.
const availableTools = filteredTools.filter((tool) => {
  if (tool.comingSoon) return false;

  const env = (runtimeEnv as unknown as Record<string, string | undefined>) || undefined;
  if (!env) return isToolVisible(tool.id);

  switch (tool.id) {
    case 'prompt-enhancer':
      return flagOn(env.PUBLIC_PROMPT_ENHANCER_V1);
    case 'Imag-Enhancer': {
      const mvpOn = flagOn(env.PUBLIC_ENHANCER_MVP_MODE);
      const legacyOn = flagOn(env.PUBLIC_ENHANCER_LEGACY_MODE);
      return mvpOn || legacyOn;
    }
    case 'video-enhancer':
      return flagOn(env.ENABLE_VIDEO_ENHANCER);
    case 'voice-visualizer':
      return flagOn(env.PUBLIC_TOOL_VOICE_VISUALIZER);
    case 'webscraper':
      return flagOn(env.PUBLIC_TOOL_WEBSCRAPER) && flagOn(env.PUBLIC_WEBSCRAPER_V1);
    case 'web-eval':
      return flagOn(env.PUBLIC_TOOL_WEB_EVAL);
    default:
      return true;
  }
});

// Get categories for filter (localized)
const categories: { id: ToolCategory; name: string }[] = getToolCategories(locale);
// Keep deterministic priority: 1) Imag-Enhancer 2) video-enhancer, then others in original order.
const priority: string[] = ['Imag-Enhancer', 'video-enhancer'];
const displayTools = [
  ...availableTools
    .filter((tool) => priority.includes(tool.id))
    .sort((a, b) => priority.indexOf(a.id) - priority.indexOf(b.id)),
  ...availableTools.filter((tool) => !priority.includes(tool.id)),
];

const modalLabels = {
  close: t('pages.tools.modal.close'),
  featuresHeading: t('pages.tools.modal.featuresHeading'),
  direct: t('pages.tools.card.direct'),
};

const modalTools = displayTools
  .filter((tool) => !tool.comingSoon)
  .map((tool) => ({
    id: tool.id,
    name: tool.name,
    description: tool.description,
    localizedUrl: localizePath(locale, tool.url),
    modal: tool.modal,
  }));
---

<style is:global>
  @import '@/styles/coming-soon.css';
  #coming-soon-overlay {
    z-index: 9999;
  }
  body.coming-soon-open {
    overflow: hidden;
  }
  article[data-coming-soon='true'] a[data-tool-link] {
    cursor: not-allowed;
    pointer-events: none;
  }
  article[data-coming-soon='true'] .flex.items-center svg {
    opacity: 0.6;
  }
</style>
<BaseLayout title={t('pages.tools.meta.title')} description={t('pages.tools.meta.description')}>
  <main class="min-h-screen bg-transparent py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-12">
        <h1
          class="text-4xl font-extrabold tracking-tight text-gray-900 dark:text-white sm:text-5xl md:text-6xl"
        >
          {t('pages.tools.heading')}
        </h1>
        <p class="mt-4 max-w-3xl mx-auto text-xl text-gray-500 dark:text-gray-300">
          {t('pages.tools.subheading')}
        </p>
      </div>

      <!-- Search and Filter Section -->
      {
        isToolsFilterEnabled() && (
          <ToolFilter
            {categories}
            activeCategory={activeCategory}
            searchQuery={searchQuery}
            resultCount={filteredTools.length}
          />
        )
      }

      <!-- Tools Grid -->
      <div id="tools-container">
        {
          availableTools.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 items-stretch gap-6 mt-8">
              {displayTools.map((tool) => (
                <ToolCard
                  id={tool.id}
                  name={tool.name}
                  description={tool.description}
                  iconKey={tool.iconKey}
                  color={tool.color}
                  url={tool.url}
                  isNew={tool.isNew}
                  isPopular={tool.isPopular}
                  comingSoon={tool.comingSoon}
                />
              ))}
            </div>
          ) : (
            <Card as="div" className="text-center py-12">
              <svg
                class="mx-auto h-12 w-12 text-gray-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">
                {t('pages.tools.empty.title')}
              </h3>
              <p class="mt-1 text-gray-500 dark:text-gray-400">
                {t('pages.tools.empty.description')}
              </p>
            </Card>
          )
        }
      </div>

      <!-- Call to Action -->
      <div class="mt-16 text-center">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          {t('pages.tools.cta.heading')}
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6 max-w-2xl mx-auto">
          {t('pages.tools.cta.description')}
        </p>
        <a
          href={localizePath(locale, '/kontakt')}
          class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-gradient-to-r from-[#00d4aa] to-[#40e0d0] hover:opacity-90 transition-opacity"
        >
          {t('pages.tools.cta.button')}
          <svg class="ml-2 -mr-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z"
              clip-rule="evenodd"></path>
          </svg>
        </a>
      </div>
    </div>
  </main>
  <ToolsIndexIsland client:load tools={modalTools} labels={modalLabels} />
</BaseLayout>
