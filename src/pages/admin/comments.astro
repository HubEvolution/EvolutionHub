---
export const prerender = false;
import BaseLayout from '@/layouts/BaseLayout.astro';
import BulkActions from '@/components/admin/BulkActions';
import Card from '@/components/ui/Card';
import AdminCommentsNotifyBridge from '@/components/admin/AdminCommentsNotifyBridge';
import AdminCommentsTableIsland from '@/components/admin/AdminCommentsTableIsland';

const q = new URL(Astro.url).searchParams;
---

<BaseLayout title="Kommentar-Moderation" description="Admin-Interface für Kommentar-Moderation">
  <main class="min-h-screen bg-transparent py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Kommentar-Moderation</h1>
        <div class="flex gap-2 sm:gap-3 flex-wrap justify-end">
          <a
            href={new URL('/api/comments', Astro.url).toString() + '?debug=1'}
            target="_blank"
            rel="noopener"
            class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 bg-white hover:bg-gray-50"
          >
            Schema-Diagnose
          </a>
          {
            q.get('entityType') && q.get('entityId') && (
              <a
                href={(function () {
                  const u = new URL('/api/comments/count', Astro.url);
                  u.searchParams.set('entityType', q.get('entityType')!);
                  u.searchParams.append('entityId', q.get('entityId')!);
                  return u.toString();
                })()}
                target="_blank"
                rel="noopener"
                class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 bg-white hover:bg-gray-50"
              >
                Approved-Count prüfen
              </a>
            )
          }
          <BulkActions client:idle />
          <button
            id="refresh-btn"
            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
            Aktualisieren
          </button>
        </div>
      </div>

      <Card as="section" className="p-6 mb-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-4">
          <div>
            <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Status</label
            >
            <select
              id="status"
              name="status"
              value={q.get('status') || ''}
              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm focus:border-emerald-500 focus:ring-emerald-500"
            >
              <option value="">Alle</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="flagged">Flagged</option>
            </select>
          </div>
          <div>
            <label
              for="entityType"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300">Entity Type</label
            >
            <select
              id="entityType"
              name="entityType"
              value={q.get('entityType') || ''}
              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm focus:border-emerald-500 focus:ring-emerald-500"
            >
              <option value="">Alle</option>
              <option value="blog_post">Blog</option>
              <option value="project">Project</option>
              <option value="general">General</option>
            </select>
          </div>
          <div>
            <label for="entityId" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Entity ID</label
            >
            <input
              id="entityId"
              name="entityId"
              type="text"
              value={q.get('entityId') || ''}
              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm focus:border-emerald-500 focus:ring-emerald-500"
            />
          </div>
          <div>
            <label for="authorId" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Autor ID</label
            >
            <input
              id="authorId"
              name="authorId"
              type="text"
              value={q.get('authorId') || ''}
              class="mt-1 block w-full rounded-md border-gray-300 dark:border-emerald-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm focus:border-emerald-500 focus:ring-emerald-500"
            />
          </div>
          <div>
            <label for="q" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Suche im Inhalt</label
            >
            <input
              id="q"
              name="q"
              type="text"
              value={q.get('q') || ''}
              class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-sm focus:border-emerald-500 focus:ring-emerald-500"
              placeholder="Stichwort im Inhalt, Autor oder E-Mail"
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Enter oder "Filtern" startet die Suche. Es wird im Kommentartext sowie im Autor‑Namen
              und der E‑Mail gesucht.
            </p>
          </div>
          <div class="flex items-end">
            <button
              type="submit"
              class="inline-flex items-center px-4 py-2 rounded-md bg-emerald-600 text-white hover:bg-emerald-700"
              >Filtern</button
            >
          </div>
        </form>
      </Card>

      <AdminCommentsTableIsland client:idle />
    </div>
  </main>

  <AdminCommentsNotifyBridge client:idle />

  <script>
    // Select-all behavior
    document.getElementById('select-all')?.addEventListener('change', (ev) => {
      const target = ev?.target as HTMLInputElement | null;
      const checked = !!(target && target.checked);
      document.querySelectorAll('input.comment-select').forEach((el) => {
        if (el instanceof HTMLInputElement) {
          el.checked = checked;
        }
      });
    });

    function ensureCsrfToken(): string {
      try {
        const cookie = document.cookie || '';
        const m = cookie.match(/(?:^|; )csrf_token=([^;]+)/);
        if (m && m[1]) return decodeURIComponent(m[1]);
        const buf = new Uint8Array(16);
        (globalThis.crypto || window.crypto).getRandomValues(buf);
        const token = Array.from(buf)
          .map((b) => b.toString(16).padStart(2, '0'))
          .join('');
        const attrs = [
          'Path=/',
          'SameSite=Lax',
          typeof location !== 'undefined' && location.protocol === 'https:' ? 'Secure' : '',
        ]
          .filter(Boolean)
          .join('; ');
        document.cookie = `csrf_token=${encodeURIComponent(token)}; ${attrs}`;
        return token;
      } catch {
        return '';
      }
    }

    function moderateComment(
      commentId: string,
      action: 'approve' | 'reject' | 'flag' | 'hide' | 'unhide'
    ) {
      const isApprove = action === 'approve';
      const reason = prompt('Grund (optional):', '') ?? '';
      if (confirm(`Kommentar wirklich ${isApprove ? 'freigeben' : 'ablehnen'}?`)) {
        const csrf = ensureCsrfToken();
        fetch(`/api/admin/comments/${commentId}/moderate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrf,
          },
          body: JSON.stringify({ action, reason }),
          credentials: 'same-origin',
        })
          .then((response) => response.json())
          .then((data: unknown) => {
            const ok = !!(
              data &&
              typeof data === 'object' &&
              (data as { success?: boolean }).success
            );
            if (ok) {
              window.dispatchEvent(
                new CustomEvent('eh:admin-comments-notify', {
                  detail: { type: 'success' },
                })
              );
              location.reload();
            } else {
              const msg =
                data && typeof data === 'object'
                  ? (data as { error?: { message?: string } }).error?.message ||
                    'Unbekannter Fehler'
                  : 'Unbekannter Fehler';
              window.dispatchEvent(
                new CustomEvent('eh:admin-comments-notify', {
                  detail: { type: 'error', message: String(msg) },
                })
              );
            }
          })
          .catch((error) => {
            console.error('Moderation error:', error);
            window.dispatchEvent(
              new CustomEvent('eh:admin-comments-notify', {
                detail: { type: 'error' },
              })
            );
          });
      }
    }

    async function viewCommentDetails(commentId: string) {
      try {
        const res = await fetch(`/api/admin/comments/${commentId}`, { credentials: 'same-origin' });
        const json = (await res.json()) as { success?: boolean; data?: any };
        if (!res.ok || !json?.success) {
          alert('Konnte Details nicht laden');
          return;
        }
        const data = (json.data ?? {}) as any;
        const c = data.comment || {};
        const contentEl = document.getElementById('comment-details-content');
        if (contentEl) {
          contentEl.innerHTML = `
            <div class="space-y-2 text-sm">
              <div><span class="font-semibold">ID:</span> ${c.id || commentId}</div>
              <div><span class="font-semibold">Status:</span> ${c.status || ''}</div>
              <div><span class="font-semibold">Autor ID:</span> ${c.authorId ?? ''}</div>
              <div><span class="font-semibold">Entity:</span> ${c.entityType || ''} / ${c.entityId || ''}</div>
              <div class="mt-2"><span class="font-semibold">Inhalt:</span><div class="mt-1 whitespace-pre-wrap">${(c.content || '').toString().replace(/</g, '&lt;')}</div></div>
            </div>
          `;
        }
        const modalEl = document.getElementById('comment-details-modal');
        const dlg = modalEl as HTMLDialogElement | null;
        if (dlg && typeof (dlg as any).showModal === 'function') {
          dlg.showModal();
        } else if (modalEl && modalEl.classList) {
          modalEl.classList.remove('hidden');
        }
      } catch (_e) {
        console.error(_e);
        alert('Fehler beim Laden der Details');
      }
    }

    // Expose handlers globally for inline onclick usage
    (window as any).moderateComment = moderateComment;
    (window as any).viewCommentDetails = viewCommentDetails;

    // Refresh-Button Funktionalität
    document.getElementById('refresh-btn')?.addEventListener('click', () => {
      location.reload();
    });
  </script>

  <!-- Details Modal -->
  <dialog id="comment-details-modal" class="backdrop:bg-black/50 rounded-lg p-0 w-full max-w-2xl">
    <form method="dialog">
      <div class="border-b px-4 py-3 flex items-center justify-between bg-gray-50 dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Kommentar-Details</h3>
        <button
          class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
          >Schließen</button
        >
      </div>
    </form>
    <div id="comment-details-content" class="p-4 text-gray-800 dark:text-gray-100"></div>
  </dialog>
</BaseLayout>
