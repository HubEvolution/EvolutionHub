---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Card from '@/components/ui/Card';
import BulkActions from '@/components/admin/BulkActions';
import AdminClient from '@/components/admin/AdminClient';
export const prerender = false;

// Admin Status (server-side)
type AdminStatusPayload = {
  success: boolean;
  data?: {
    user: { id: string; email: string };
    plan: 'free' | 'pro' | 'premium' | 'enterprise';
    credits: number;
    subscriptions: Array<{
      id: string;
      plan: 'free' | 'pro' | 'premium' | 'enterprise';
      status: string;
      current_period_end: number | null;
      cancel_at_period_end: number | null;
      created_at: string;
      updated_at: string;
    }>;
  };
};

type AdminReferralSummaryPayload = {
  success: boolean;
  data?: {
    stats: {
      totals: {
        totalEvents: number;
        totalCredits: number;
        ownerCount: number;
        referredCount: number;
      };
      breakdown: {
        pending: number;
        verified: number;
        paid: number;
        cancelled: number;
      };
    };
    recentEvents: Array<{
      id: string;
      status: 'pending' | 'verified' | 'paid' | 'cancelled';
      referralCode: string;
      creditsAwarded: number;
      occurredAt: number;
      owner: { userId: string; email?: string; name?: string };
      referred: { userId: string; email?: string } | null;
    }>;
    topOwners: Array<{
      userId: string;
      email?: string;
      name?: string;
      eventCount: number;
      totalCredits: number;
      lastEventAt: number;
    }>;
  };
};

async function fetchAdminStatus(): Promise<AdminStatusPayload | null> {
  const ac = new AbortController();
  const timer = setTimeout(() => ac.abort('timeout'), 2500);
  try {
    const url = new URL('/api/admin/status', Astro.url).toString();
    const res = await fetch(url, {
      headers: { cookie: Astro.request.headers.get('cookie') ?? '' },
      cache: 'no-store',
      signal: ac.signal,
    });
    if (!res.ok) return null;
    return (await res.json()) as AdminStatusPayload;
  } catch {
    return null;
  } finally {
    clearTimeout(timer);
  }
}

async function fetchAdminReferralSummary(): Promise<AdminReferralSummaryPayload | null> {
  const ac = new AbortController();
  const timer = setTimeout(() => ac.abort('timeout'), 2500);
  try {
    const url = new URL('/api/admin/referrals/summary', Astro.url).toString();
    const res = await fetch(url, {
      headers: { cookie: Astro.request.headers.get('cookie') ?? '' },
      cache: 'no-store',
      signal: ac.signal,
    });
    if (!res.ok) return null;
    return (await res.json()) as AdminReferralSummaryPayload;
  } catch {
    return null;
  } finally {
    clearTimeout(timer);
  }
}

function formatNumber(value: number | null | undefined): string {
  if (!Number.isFinite(value)) {
    return '0';
  }
  return new Intl.NumberFormat('de-DE').format(Number(value));
}

function formatDateTime(timestamp: number | null | undefined): string {
  if (!timestamp) {
    return '—';
  }

  const date = new Date(timestamp);
  if (Number.isNaN(date.getTime())) {
    return '—';
  }

  return new Intl.DateTimeFormat('de-DE', {
    year: 'numeric',
    month: 'short',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  }).format(date);
}

const adminStatus = await fetchAdminStatus();
const adminCommentsList: any[] = [];
const adminCommentsStats = { total: 0, pending: 0, approved: 0, rejected: 0, flagged: 0 };
const referralSummaryPayload = await fetchAdminReferralSummary();
const referralSummaryData = referralSummaryPayload?.success ? referralSummaryPayload.data ?? null : null;
const referralSummaryError = referralSummaryPayload ? !referralSummaryPayload.success : false;
const referralStats = referralSummaryData?.stats;
const referralRecentEvents = referralSummaryData?.recentEvents ?? [];
const referralTopOwners = referralSummaryData?.topOwners ?? [];
const referralStatusLabels: Record<'pending' | 'verified' | 'paid' | 'cancelled', string> = {
  pending: 'Ausstehend',
  verified: 'Bestätigt',
  paid: 'Ausgezahlt',
  cancelled: 'Storniert',
};
---

<BaseLayout title={`Admin Dashboard`} description={`Zentrale Admin-Startseite`}>
  <main class="min-h-screen bg-transparent py-12 px-4 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-6xl space-y-8">
      <header class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Admin Dashboard</h1>
      </header>

      <section class="grid grid-cols-1 gap-6 md:grid-cols-2">
        <!-- User Lookup -->
        <Card as="section" className="p-6">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">User Lookup</h2>
          <form id="lookup-form" class="space-y-3" onsubmit="return false;">
            <label class="block text-sm text-gray-300">
              E-Mail oder User-ID
              <input
                id="lookup-input"
                type="text"
                class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                placeholder="admin@hub-evolution.com oder user_id"
              />
            </label>
            <div class="flex gap-2">
              <button
                id="lookup-btn"
                type="button"
                class="rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700"
                >Suchen</button
              >
              <button
                id="lookup-clear"
                class="rounded-md border border-white/10 px-3 py-2 text-sm text-white/80 hover:bg-white/5"
                type="button">Zurücksetzen</button
              >
            </div>
          </form>
          <div id="lookup-result" class="mt-4 hidden">
            <div class="text-sm text-white/80">
              <div><span class="text-white/50">ID:</span> <span id="lr-id"></span></div>
              <div><span class="text-white/50">E‑Mail:</span> <span id="lr-email"></span></div>
              <div><span class="text-white/50">Name:</span> <span id="lr-name"></span></div>
              <div><span class="text-white/50">Plan:</span> <span id="lr-plan"></span></div>
              <div><span class="text-white/50">Credits:</span> <span id="lr-credits"></span></div>
              <div><span class="text-white/50">Subscription:</span> <span id="lr-sub"></span></div>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span class="text-white/50">Last seen:</span>
                <span id="lr-last-seen"></span>
                <span class="text-white/50">• IP:</span>
                <span id="lr-last-ip"></span>
                <button
                  id="lr-ip-geo"
                  class="rounded-md border border-white/10 px-2 py-1 text-xs text-white/80 hover:bg-white/5"
                  type="button">Ort ermitteln</button
                >
                <span id="lr-ip-geo-out" class="text-white/60"></span>
              </div>
              <div class="mt-2">
                <button
                  id="lr-apply-userid"
                  class="rounded-md bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-emerald-700"
                  type="button">ID in Credits übernehmen</button
                >
              </div>
            </div>
          </div>
          <div id="lookup-error" class="mt-3 hidden text-sm text-red-300"></div>
        </Card>

        <!-- Credits & Plan (merged with Plan ändern; spans two columns) -->
        <Card as="section" className="p-6 md:col-span-2">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">Credits & Plan</h2>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <!-- Credits -->
            <div class="md:pr-6">
              <h3 class="mb-2 text-lg font-medium text-white/90">Credits</h3>
              <form id="grant-form" class="space-y-3" onsubmit="return false;">
                <label class="block text-sm text-gray-300">
                  E-Mail
                  <input
                    id="grant-email"
                    type="email"
                    class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    placeholder="admin@hub-evolution.com"
                  />
                </label>
                <label class="block text-sm text-gray-300">
                  Betrag (Credits)
                  <input
                    id="grant-amount"
                    type="number"
                    min="1"
                    step="1"
                    value="1000"
                    class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  />
                </label>
                <label class="flex items-center gap-2 text-sm text-white/80">
                  <input
                    id="grant-strict"
                    type="checkbox"
                    checked
                    class="h-4 w-4 rounded border-white/20 bg-white/5"
                  />
                  <span>Strikt: nicht mehr abziehen als vorhanden</span>
                </label>
                <div class="flex flex-wrap items-center gap-2">
                  <button
                    id="grant-btn"
                    type="button"
                    class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700"
                    >Gutschreiben</button
                  >
                  <button
                    id="grant-deduct"
                    type="button"
                    class="rounded-md bg-rose-600 px-3 py-2 text-sm font-semibold text-white hover:bg-rose-700"
                    >Abziehen</button
                  >
                  <button
                    id="grant-fill-self"
                    type="button"
                    class="rounded-md border border-white/10 px-3 py-2 text-sm text-white/80 hover:bg-white/5"
                    >Meine E‑Mail einsetzen</button
                  >
                  <span class="text-xs text-white/60"
                    >Erfordert Admin & aktives INTERNAL_CREDIT_GRANT</span
                  >
                </div>
              </form>
              <div id="grant-success" class="mt-3 hidden text-sm text-emerald-300"></div>
              <div id="grant-error" class="mt-3 hidden text-sm text-red-300"></div>
            </div>

            <!-- Plan ändern -->
            <div class="md:border-l md:border-white/10 md:pl-6">
              <h3 class="mb-2 text-lg font-medium text-white/90">Plan ändern</h3>
              <form id="plan-form" class="space-y-3" onsubmit="return false;">
                <label class="block text-sm text-gray-300">
                  E‑Mail oder User‑ID
                  <input
                    id="plan-target"
                    type="text"
                    class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    placeholder="email@example.com oder user_id"
                  />
                </label>
                <label class="block text-sm text-gray-300">
                  Neuer Plan
                  <select
                    id="plan-select"
                    class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  >
                    <option value="free">free</option>
                    <option value="pro">pro</option>
                    <option value="premium">premium</option>
                    <option value="enterprise">enterprise</option>
                  </select>
                </label>
                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                  <label class="block text-sm text-gray-300">
                    Intervall
                    <select
                      id="plan-interval"
                      class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    >
                      <option value="monthly" selected>monthly</option>
                      <option value="annual">annual</option>
                    </select>
                  </label>
                  <label class="block text-sm text-gray-300">
                    Proration
                    <select
                      id="plan-proration"
                      class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    >
                      <option value="create_prorations" selected>create_prorations</option>
                      <option value="none">none</option>
                    </select>
                  </label>
                </div>
                <div id="plan-cancel-group" class="hidden">
                  <label class="inline-flex items-center gap-2 text-sm text-gray-300">
                    <input
                      id="plan-cancel-immediate"
                      type="checkbox"
                      class="h-4 w-4 rounded border-white/20 bg-white/5 text-emerald-600 focus:ring-emerald-500"
                    />
                    Sofort kündigen (statt zum Periodenende)
                  </label>
                </div>
                <label class="block text-sm text-gray-300">
                  Grund (optional)
                  <input
                    id="plan-reason"
                    type="text"
                    class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    placeholder="warum wird der Plan gesetzt?"
                  />
                </label>
                <div class="flex flex-wrap items-center gap-2">
                  <button
                    id="plan-set-btn"
                    type="button"
                    class="rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700"
                    >Plan setzen</button
                  >
                  <span class="text-xs text-white/60"
                    >Nur für Admins. Achtung: Stripe‑Webhooks können Plan später überschreiben.</span
                  >
                </div>
              </form>
              <div id="plan-success" class="mt-3 hidden text-sm text-emerald-300"></div>
              <div id="plan-error" class="mt-3 hidden text-sm text-red-300"></div>
            </div>
          </div>
        </Card>

        <!-- System Health -->
        <Card as="section" className="p-6">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">System Health</h2>
          <div class="flex items-center gap-3">
            <button
              id="health-btn"
              type="button"
              class="rounded-md bg-teal-600 px-3 py-2 text-sm font-semibold text-white hover:bg-teal-700"
              >/api/health prüfen</button
            >
            <div id="health-status" class="text-sm text-white/80"></div>
          </div>
        </Card>

        <!-- Live‑Metriken + Traffic (24h) merged; spans two columns) -->
        <Card as="section" className="p-6 md:col-span-2">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">
            Live‑Metriken & Traffic (24h)
          </h2>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <!-- Live‑Metriken -->
            <div class="md:pr-6">
              <h3 class="mb-2 text-lg font-medium text-white/90">Live‑Metriken</h3>
              <div class="grid grid-cols-2 gap-4 text-sm text-white/80 md:grid-cols-2">
                <div class="rounded-md border border-white/10 p-3">
                  <div class="text-white/50">Aktive Sessions</div>
                  <div id="m-active-sessions" class="text-xl font-semibold">–</div>
                </div>
                <div class="rounded-md border border-white/10 p-3">
                  <div class="text-white/50">Aktive User</div>
                  <div id="m-active-users" class="text-xl font-semibold">–</div>
                </div>
                <div class="rounded-md border border-white/10 p-3">
                  <div class="text-white/50">User gesamt</div>
                  <div id="m-users-total" class="text-xl font-semibold">–</div>
                </div>
                <div class="rounded-md border border-white/10 p-3">
                  <div class="text-white/50">Neu (24h)</div>
                  <div id="m-users-new24h" class="text-xl font-semibold">–</div>
                </div>
              </div>
            </div>

            <!-- Traffic (24h) -->
            <div class="md:border-l md:border-white/10 md:pl-6">
              <h3 class="mb-2 text-lg font-medium text-white/90">Traffic (24h)</h3>
              <div class="grid grid-cols-2 gap-4 text-sm text-white/80">
                <div class="rounded-md border border-white/10 p-3">
                  <div class="text-white/50">Pageviews</div>
                  <div id="traffic-pageviews" class="text-xl font-semibold">–</div>
                </div>
                <div class="rounded-md border border-white/10 p-3">
                  <div class="text-white/50">Unique Visitors</div>
                  <div id="traffic-visits" class="text-xl font-semibold">–</div>
                </div>
              </div>
              <div class="mt-3">
                <svg
                  id="traffic-sparkline"
                  viewBox="0 0 200 36"
                  class="h-9 w-full text-emerald-400/90"></svg>
              </div>
            </div>
          </div>
        </Card>

        <!-- Admin Status (embedded) -->
        <Card as="section" className="p-6">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">Admin Status</h2>
          <div id="admin-status-container">
            {
              adminStatus?.success && adminStatus?.data ? (
                <div class="grid grid-cols-1 gap-3 text-sm text-white/80 sm:grid-cols-2">
                  <div>
                    <span class="text-white/50">User ID:</span> {adminStatus.data.user.id}
                  </div>
                  <div>
                    <span class="text-white/50">E‑Mail:</span> {adminStatus.data.user.email}
                  </div>
                  <div>
                    <span class="text-white/50">Plan:</span> {adminStatus.data.plan}
                  </div>
                  <div>
                    <span class="text-white/50">Credits:</span> {adminStatus.data.credits}
                  </div>
                  <div class="sm:col-span-2">
                    <div class="text-white/50 mb-1">Letzte Subscriptions</div>
                    <ul class="space-y-1">
                      {adminStatus.data.subscriptions.slice(0, 3).map((s) => (
                        <li>
                          <span class="text-white/70">{s.plan}</span>
                          <span class="text-white/40"> • {s.status}</span>
                          <span class="text-white/40">
                            {' '}
                            • Ende:{' '}
                            {s.current_period_end
                              ? new Date(s.current_period_end * 1000).toLocaleString()
                              : '—'}
                          </span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              ) : (
                <div class="text-sm text-red-300">Status konnte nicht geladen werden.</div>
              )
            }
          </div>
        </Card>

        <!-- Referral Insights -->
        <Card as="section" className="p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Referral Insights</h2>
              <p class="mt-1 text-sm text-white/70">
                Übersicht über Referral-Aktivitäten, Top-Owner und Auszahlungen.
              </p>
            </div>
          </div>

          {referralSummaryError ? (
            <div class="mt-4 rounded-md border border-red-400/40 bg-red-500/10 p-4 text-sm text-red-200">
              Zusammenfassung konnte nicht geladen werden.
            </div>
          ) : referralSummaryData ? (
            <div class="mt-6 space-y-6">
              <div class="grid grid-cols-2 gap-4 text-sm text-white/80 sm:grid-cols-4">
                <div class="rounded-md border border-white/10 bg-white/5 p-3">
                  <div class="text-xs uppercase tracking-wide text-white/50">Events gesamt</div>
                  <div class="mt-1 text-xl font-semibold text-white">
                    {formatNumber(referralStats?.totals.totalEvents ?? 0)}
                  </div>
                </div>
                <div class="rounded-md border border-white/10 bg-white/5 p-3">
                  <div class="text-xs uppercase tracking-wide text-white/50">Credits gesamt</div>
                  <div class="mt-1 text-xl font-semibold text-emerald-300">
                    +{formatNumber(referralStats?.totals.totalCredits ?? 0)}
                  </div>
                </div>
                <div class="rounded-md border border-white/10 bg-white/5 p-3">
                  <div class="text-xs uppercase tracking-wide text-white/50">Owner mit Events</div>
                  <div class="mt-1 text-xl font-semibold text-white">
                    {formatNumber(referralStats?.totals.ownerCount ?? 0)}
                  </div>
                </div>
                <div class="rounded-md border border-white/10 bg-white/5 p-3">
                  <div class="text-xs uppercase tracking-wide text-white/50">Geworbene Nutzer</div>
                  <div class="mt-1 text-xl font-semibold text-white">
                    {formatNumber(referralStats?.totals.referredCount ?? 0)}
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <div class="space-y-3">
                  <h3 class="text-sm font-semibold uppercase tracking-wide text-white/60">
                    Status Breakdown
                  </h3>
                  <ul class="space-y-2 text-sm text-white/80">
                    {(['pending', 'verified', 'paid', 'cancelled'] as const).map((statusKey) => (
                      <li class="flex items-center justify-between rounded-md border border-white/10 bg-white/5 px-3 py-2">
                        <span class="text-white/60">{referralStatusLabels[statusKey]}</span>
                        <span class="font-semibold text-white">
                          {formatNumber(referralStats?.breakdown[statusKey] ?? 0)}
                        </span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div class="space-y-3">
                  <h3 class="text-sm font-semibold uppercase tracking-wide text-white/60">
                    Top Owner nach Credits
                  </h3>
                  {referralTopOwners.length > 0 ? (
                    <ul class="space-y-2 text-sm text-white/80">
                      {referralTopOwners.map((owner) => (
                        <li class="rounded-md border border-white/10 bg-white/5 px-3 py-2">
                          <div class="flex items-center justify-between">
                            <div>
                              <div class="font-semibold text-white">{owner.name ?? owner.email ?? owner.userId}</div>
                              <div class="text-xs text-white/50">Events: {formatNumber(owner.eventCount)}</div>
                            </div>
                            <div class="text-right">
                              <div class="text-sm font-semibold text-emerald-200">
                                +{formatNumber(owner.totalCredits)} Credits
                              </div>
                              <div class="text-xs text-white/50">
                                Zuletzt: {formatDateTime(owner.lastEventAt)}
                              </div>
                            </div>
                          </div>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p class="text-sm text-white/60">Noch keine Owner mit Auszahlungen.</p>
                  )}
                </div>
              </div>

              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold uppercase tracking-wide text-white/60">
                    Neueste Events
                  </h3>
                  <span class="text-xs text-white/50">
                    {referralRecentEvents.length} Einträge
                  </span>
                </div>
                {referralRecentEvents.length > 0 ? (
                  <div class="overflow-hidden rounded-lg border border-white/10">
                    <table class="min-w-full divide-y divide-white/10 text-sm text-white/80">
                      <thead class="bg-white/5 text-xs uppercase tracking-wide text-white/60">
                        <tr>
                          <th class="px-3 py-2 text-left">Status</th>
                          <th class="px-3 py-2 text-left">Referral Code</th>
                          <th class="px-3 py-2 text-left">Owner</th>
                          <th class="px-3 py-2 text-left">Referred</th>
                          <th class="px-3 py-2 text-right">Credits</th>
                          <th class="px-3 py-2 text-left">Datum</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-white/5 bg-white/5">
                        {referralRecentEvents.map((event) => (
                          <tr>
                            <td class="px-3 py-2 text-xs font-semibold uppercase text-emerald-300">
                              {referralStatusLabels[event.status]}
                            </td>
                            <td class="px-3 py-2 font-mono text-xs text-white/70">{event.referralCode}</td>
                            <td class="px-3 py-2">
                              {event.owner.name ?? event.owner.email ?? event.owner.userId}
                            </td>
                            <td class="px-3 py-2">
                              {event.referred ? event.referred.email ?? event.referred.userId : '—'}
                            </td>
                            <td class="px-3 py-2 text-right font-semibold text-white">
                              +{formatNumber(event.creditsAwarded)}
                            </td>
                            <td class="px-3 py-2 text-xs text-white/60">
                              {formatDateTime(event.occurredAt)}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <p class="text-sm text-white/60">Noch keine Referral-Events vorhanden.</p>
                )}
              </div>
            </div>
          ) : (
            <div class="mt-4 rounded-md border border-white/10 bg-white/5 p-4 text-sm text-white/70">
              Keine Referral-Daten verfügbar.
            </div>
          )}
        </Card>

        <!-- Audit Logs -->
        <Card as="section" className="p-6">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">Audit Logs</h2>
          <div class="flex items-center gap-3">
            <button
              id="audit-load"
              type="button"
              class="rounded-md bg-sky-600 px-3 py-2 text-sm font-semibold text-white hover:bg-sky-700"
              >Letzte 10 laden</button
            >
            <label class="text-sm text-white/70 hidden">
              Typ
              <select
                id="audit-type"
                class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-white/90"
              >
                <option value="">Alle</option>
                <option value="API_ACCESS">API_ACCESS</option>
                <option value="ADMIN_ACTION">ADMIN_ACTION</option>
                <option value="SECURITY_EVENT">SECURITY_EVENT</option>
              </select>
            </label>
          </div>
          <div id="audit-error" class="mt-3 hidden text-sm text-red-300"></div>
          <div id="audit-list" class="mt-4 max-h-[260px] overflow-y-auto text-sm text-white/80">
          </div>
        </Card>

        <!-- Sessions Management -->
        <Card as="section" className="p-6">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">Credits Usage</h2>
          <div class="flex flex-wrap items-end gap-3">
            <label class="block text-sm text-gray-300">
              E‑Mail oder User‑ID
              <input
                id="cu-userid"
                type="text"
                class="mt-1 w-full rounded-md border border-white/10 bg-white/5 p-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                placeholder="user_id oder email@example.com"
              />
            </label>
            <button
              id="cu-balance"
              type="button"
              class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700"
              >Balance laden</button
            >
            <button
              id="cu-packs"
              type="button"
              class="rounded-md bg-sky-600 px-3 py-2 text-sm font-semibold text-white hover:bg-sky-700"
              >Packs laden</button
            >
            <button
              id="cu-copy-balance"
              type="button"
              class="rounded-md border border-white/10 px-3 py-2 text-sm text-white/80 hover:bg-white/5"
              >Copy cURL Balance</button
            >
            <button
              id="cu-copy-packs"
              type="button"
              class="rounded-md border border-white/10 px-3 py-2 text-sm text-white/80 hover:bg-white/5"
              >Copy cURL Packs</button
            >
          </div>
          <div id="cu-error" class="mt-3 hidden text-sm text-red-300"></div>
          <div class="mt-4 text-sm text-white/80">
            <div id="cu-balance-out" class="mb-3"></div>
            <div id="cu-packs-list" class="max-h-[260px] overflow-y-auto"></div>
          </div>
        </Card>

        <!-- Kommentar-Moderation (embedded) -->
        <Card as="section" className="p-6 md:col-span-2">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">
            Kommentar‑Moderation
          </h2>
          <div class="mb-3 text-sm text-white/70">
            <span class="mr-3">Total: <span id="cstat-total">{adminCommentsStats.total}</span></span
            >
            <span class="mr-3"
              >Pending: <span id="cstat-pending">{adminCommentsStats.pending}</span></span
            >
            <span class="mr-3"
              >Approved: <span id="cstat-approved">{adminCommentsStats.approved}</span></span
            >
            <span class="mr-3"
              >Rejected: <span id="cstat-rejected">{adminCommentsStats.rejected}</span></span
            >
            <span>Flagged: <span id="cstat-flagged">{adminCommentsStats.flagged}</span></span>
          </div>
          <div class="mb-3 flex items-center gap-3">
            <label class="text-sm text-white/70 flex items-center gap-2">
              Status
              <select
                id="c-status"
                class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-white/90"
              >
                <option value="all">Alle</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="flagged">Flagged</option>
              </select>
            </label>
            <div class="ml-auto flex items-center gap-2">
              <button
                id="c-prev"
                class="rounded-md border border-white/10 px-2 py-1 text-sm text-white/80 hover:bg-white/5"
                type="button">Zurück</button
              >
              <span id="c-page" class="text-sm text-white/60">–</span>
              <button
                id="c-next"
                class="rounded-md border border-white/10 px-2 py-1 text-sm text-white/80 hover:bg-white/5"
                type="button">Weiter</button
              >
            </div>
          </div>
          <div class="overflow-x-auto max-h-[520px] overflow-y-auto">
            <table class="min-w-full text-sm text-white/80">
              <thead>
                <tr class="text-left text-white/50">
                  <th class="px-2 py-1"><input type="checkbox" id="check-all" /></th>
                  <th class="px-2 py-1">ID</th>
                  <th class="px-2 py-1">Autor</th>
                  <th class="px-2 py-1">Entity</th>
                  <th class="px-2 py-1">Status</th>
                  <th class="px-2 py-1">Created</th>
                </tr>
              </thead>
              <tbody id="comments-tbody">
                {
                  adminCommentsList.map((c) => (
                    <tr class="border-t border-white/10">
                      <td class="px-2 py-1">
                        <input type="checkbox" class="comment-select" data-comment-id={c.id} />
                      </td>
                      <td class="px-2 py-1 whitespace-nowrap">{c.id}</td>
                      <td class="px-2 py-1">{c.author?.email || '—'}</td>
                      <td class="px-2 py-1">
                        {c.entityType}:{c.entityId}
                      </td>
                      <td class="px-2 py-1">{c.status}</td>
                      <td class="px-2 py-1 whitespace-nowrap">{c.createdAt}</td>
                    </tr>
                  ))
                }
              </tbody>
            </table>
            <div class="mt-3">
              <BulkActions client:load />
            </div>
          </div>
        </Card>
      </section>
    </div>
  </main>
  <AdminClient client:load />
</BaseLayout>
