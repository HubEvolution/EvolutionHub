
---
// src/components/Header.astro

import ThemeToggle from './ThemeToggle.astro';
// Korrigierter Import für getLocale – erwartet einen benannten Export und .js Erweiterung
import { getLocale } from '@/lib/i18n';
// Import der dedizierten Scroll-Effect Komponente
import HeaderScroll from './scripts/HeaderScroll.astro';
import EvolutionHubLogo from 'public/assets/svg/evolutionhub-mark.svg';
import { localizePath } from '@/lib/locale-path';

// Get current locale for language switching
// These variables should be defined in Markdown Frontmatter or accessible in the script.
// Ensuring they are correctly defined and typed.
const currentLocale = getLocale(Astro.url.pathname);
const user = (Astro.props as any)?.user as { name?: string; email?: string; image?: string } | undefined;

// Helper für aktive Navigation: vergleicht gegen lokalisierte Hrefs
function isActiveLocalized(href: string): boolean {
  const localized = localizePath(currentLocale, href);
  if (currentPath === localized) return true;
  // Sub-Routen (z. B. Dashboard-Unterseiten)
  return currentPath.startsWith(localized.endsWith('/') ? localized : `${localized}/`);
}

// Navigation items with ARIA labels
const navItems = [
  { name: 'Dashboard', href: '/dashboard', 'aria-label': 'Go to Dashboard' },
  { name: 'Tools', href: '/tools', 'aria-label': 'View available tools' },
  { name: 'Pricing', href: '/pricing', 'aria-label': 'View pricing plans' },
  { name: 'Blog', href: '/blog', 'aria-label': 'View blog posts' },
];

// Get current URL and path for active link highlighting
const url = Astro.url;
const currentPath = url.pathname;

// (entfernt) Unbenutzte isActive-Hilfsfunktion, um Lint-Fehler zu vermeiden

// Baue Sprachwechsel-Link mit persistenter Auswahl via set_locale & next
// - next verweist auf die aktuelle vollständige URL (inkl. Query/Hash), URL-enkodiert
// - Basis-Link bleibt der aktuelle Pfad; das Middleware-Redirect mappt anhand von `next` auf die Ziel-Locale
function setLocaleHref(target: 'de' | 'en'): string {
  const base = Astro.url.pathname;
  const next = encodeURIComponent(Astro.url.toString());
  const sep = base.includes('?') ? '&' : '?';
  // Entferne etwaige Hash-Fragmente aus base, damit wir ein sauberes Query anhängen
  const cleanBase = base.split('#')[0];
  return `${cleanBase}${sep}set_locale=${target}&next=${next}`;
}
---

<header
  id="site-header"
  data-testid="site-header"
  data-aos="fade-down"
  data-aos-duration="600"
  data-aos-once="true"
  data-aos-anchor-placement="top-top"
  data-aos-easing="ease-out"
  class="sticky top-0 z-50 mx-4 md:mx-8 rounded-2xl glass-header header-visible bg-transparent backdrop-blur-0 md:backdrop-blur"
  style="background: transparent; background-image: none;"
>
  <!-- Background overlays to match Footer gradient/pattern -->
  <div class="absolute inset-0 overflow-hidden rounded-2xl z-0 pointer-events-none" aria-hidden="true">
    <div class="absolute inset-0 bg-gradient-to-b from-gray-900/10 to-transparent md:from-gray-900/90 md:to-black/90"></div>
    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTAgMEgxMDBWMTBIMFYwWk0wIDkwSDEwMFYxMDBIMFY5MFpNMCA0NUgxMDBWNTVIMFY0NVpNNDUgMEg1NVYxMEg0NVYwWk00NSA0NUg1NVY1NUg0NVY0NVpNNDUgOTBINTVWMTAwSDQ1VjkwWk0wIDIyLjVIMTAwVjMyLjVIMFYyMi41Wk0wIDY3LjVIMTAwVjc3LjVINlY2Ny41WiIgZmlsbD0icmdiYSgxNiwxODUsMTQ4LDAuMDUpIi8+Cjwvc3ZnPg==')] opacity-0 md:opacity-20"></div>
  </div>

  <nav class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" aria-label="Main navigation">
    <div class="flex items-center justify-between h-20">
      <!-- Logo -->
      <div class="flex-shrink-0 flex items-center group">
        <a
          href={localizePath(currentLocale, '/')}
          class="flex items-center space-x-3 group-hover:scale-105 transition-transform duration-300"
        >
          <EvolutionHubLogo class="w-9 h-9 md:w-10 md:h-10" />
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:ml-10 md:flex md:items-center md:space-x-1">
        {
          navItems.map((item) => (
            <a
              href={localizePath(currentLocale, item.href)}
              class={`relative px-4 py-2.5 text-sm font-medium transition-all duration-300 rounded-lg group ${
                isActiveLocalized(item.href)
                  ? 'text-emerald-600 dark:text-emerald-400'
                  : 'text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white'
              }`}
              aria-current={isActiveLocalized(item.href) ? 'page' : undefined}
              aria-label={item['aria-label']}
            >
              {item.name}
              {isActiveLocalized(item.href) && (
                <span class="absolute inset-x-1 -bottom-1 h-0.5 bg-accent-gradient rounded-full" />
              )}
              <span class="absolute inset-x-1 -bottom-1 h-0.5 bg-accent-gradient rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300" />
              {isActiveLocalized(item.href) && <span class="sr-only">(current page)</span>}
            </a>
          ))
        }
      </div>

      <div class="flex items-center space-x-3">

        {user && (
          <div class="hidden md:flex items-center">
            <button
              type="button"
              id="user-menu-button"
              class="inline-flex items-center gap-2 rounded-full bg-white/60 px-2.5 py-1.5 text-sm font-medium text-gray-800 shadow-sm ring-1 ring-gray-200 backdrop-blur-md transition hover:bg-white/80 dark:bg-slate-800/60 dark:text-slate-100 dark:ring-slate-700"
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="user-menu-dropdown"
            >
              <img
                src={user.image || '/assets/svg/logo.svg'}
                alt="User avatar"
                class="h-7 w-7 rounded-full ring-2 ring-emerald-500/20"
                data-avatar-img
              />
              <span class="max-w-[10rem] truncate hidden sm:block">{user.name || 'Account'}</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </button>
            <div
              id="user-menu-dropdown"
              role="menu"
              aria-labelledby="user-menu-button"
              class="absolute right-4 top-[4.5rem] w-64 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-gray-200 dark:border-slate-700 py-2 z-50 opacity-0 transform scale-95 transition-all duration-200 pointer-events-none"
            >
              <a
                href={localizePath(currentLocale, '/dashboard')}
                class="flex items-center gap-2 px-4 py-2 text-sm text-gray-800 dark:text-slate-100 hover:bg-gray-50 dark:hover:bg-slate-800/60"
                role="menuitem"
              >
                <span>Profil & Einstellungen</span>
              </a>
              <div class="my-2 h-px bg-gray-100 dark:bg-slate-800"></div>
              <div class="px-4 py-2 text-xs text-gray-500 dark:text-slate-400">Plan & Usage</div>
              <div class="px-4 pb-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600 dark:text-slate-300">Plan</span>
                  <span id="user-plan" class="font-medium text-gray-900 dark:text-white">—</span>
                </div>
                <div class="mt-1.5 flex items-center justify-between">
                  <span class="text-gray-600 dark:text-slate-300">Credits</span>
                  <span id="user-credits" class="font-medium text-gray-900 dark:text-white">—</span>
                </div>
                <div class="mt-1.5 flex items-center justify-between">
                  <span class="text-gray-600 dark:text-slate-300">Monthly quota</span>
                  <span id="user-quota" class="font-medium text-gray-900 dark:text-white">—</span>
                </div>
              </div>

              <div class="my-2 h-px bg-gray-100 dark:bg-slate-800"></div>
              <div class="px-4 py-2 text-xs text-gray-500 dark:text-slate-400">Darstellung</div>
              <div class="px-4 pb-2">
                <ThemeToggle />
              </div>

              <div class="my-2 h-px bg-gray-100 dark:bg-slate-800"></div>
              <div class="px-4 py-2 text-xs text-gray-500 dark:text-slate-400">Sprache</div>
              <div class="px-2 pb-2">
                <a
                  href={setLocaleHref('de')}
                  class={`flex items-center px-3 py-2 text-sm rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 ${
                    currentLocale === 'de'
                      ? 'text-emerald-600 dark:text-emerald-400 font-medium'
                      : 'text-gray-700 dark:text-gray-300'
                  }`}
                  data-astro-reload
                >
                  Deutsch
                  {currentLocale === 'de' && (
                    <svg class="ml-auto w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  )}
                </a>
                <a
                  href={setLocaleHref('en')}
                  class={`flex items-center px-3 py-2 text-sm rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 ${
                    currentLocale === 'en'
                      ? 'text-emerald-600 dark:text-emerald-400 font-medium'
                      : 'text-gray-700 dark:text-gray-300'
                  }`}
                  data-astro-reload
                >
                  English
                  {currentLocale === 'en' && (
                    <svg class="ml-auto w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  )}
                </a>
              </div>
              <div class="my-2 h-px bg-gray-100 dark:bg-slate-800"></div>
              <a
                href="/api/user/logout"
                class="flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20"
                role="menuitem"
              >
                Abmelden
              </a>
            </div>
          </div>
        )}

        {!user && (
          <div class="hidden md:flex items-center">
            <button
              type="button"
              id="user-menu-button"
              class="inline-flex items-center gap-2 rounded-full bg-white/60 px-2.5 py-1.5 text-sm font-medium text-gray-800 shadow-sm ring-1 ring-gray-200 backdrop-blur-md transition hover:bg-white/80 dark:bg-slate-800/60 dark:text-slate-100 dark:ring-slate-700"
              title={currentLocale === 'de' ? 'Anmelden' : 'Login'}
              aria-label={currentLocale === 'de' ? 'Anmelden' : 'Login'}
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="user-menu-dropdown"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
                class="h-7 w-7 rounded-full ring-2 ring-emerald-500/20"
              >
                <path d="M10 9a3 3 0 100-6 3 3 0 000 6z" />
                <path d="M4 16a6 6 0 1112 0H4z" />
              </svg>
              <span class="max-w-[10rem] truncate hidden sm:block">{currentLocale === 'de' ? 'Anmelden' : 'Login'}</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </button>
            <div
              id="user-menu-dropdown"
              role="menu"
              aria-labelledby="user-menu-button"
              class="absolute right-4 top-[4.5rem] w-64 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-gray-200 dark:border-slate-700 py-2 z-50 opacity-0 transform scale-95 transition-all duration-200 pointer-events-none"
            >
              <div class="px-4 py-2 text-xs text-gray-500 dark:text-slate-400">Darstellung</div>
              <div class="px-4 pb-2">
                <ThemeToggle />
              </div>

              <div class="my-2 h-px bg-gray-100 dark:bg-slate-800"></div>
              <div class="px-4 py-2 text-xs text-gray-500 dark:text-slate-400">Sprache</div>
              <div class="px-2 pb-2">
                <a
                  href={setLocaleHref('de')}
                  class={`flex items-center px-3 py-2 text-sm rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 ${
                    currentLocale === 'de'
                      ? 'text-emerald-600 dark:text-emerald-400 font-medium'
                      : 'text-gray-700 dark:text-gray-300'
                  }`}
                  data-astro-reload
                >
                  Deutsch
                  {currentLocale === 'de' && (
                    <svg class="ml-auto w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  )}
                </a>
                <a
                  href={setLocaleHref('en')}
                  class={`flex items-center px-3 py-2 text-sm rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 ${
                    currentLocale === 'en'
                      ? 'text-emerald-600 dark:text-emerald-400 font-medium'
                      : 'text-gray-700 dark:text-gray-300'
                  }`}
                  data-astro-reload
                >
                  English
                  {currentLocale === 'en' && (
                    <svg class="ml-auto w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  )}
                </a>
              </div>

              <div class="my-2 h-px bg-gray-100 dark:bg-slate-800"></div>
              <a
                href={localizePath(currentLocale, '/login')}
                class="flex items-center gap-2 px-4 py-2 text-sm text-emerald-600 hover:bg-emerald-50 dark:text-emerald-400 dark:hover:bg-emerald-900/20"
                role="menuitem"
              >
                {currentLocale === 'de' ? 'Anmelden' : 'Login'}
              </a>
            </div>
          </div>
        )}

        <!-- Language Switcher moved into user dropdown -->

        <!-- Mobile Menu Button -->
        <div class="md:hidden">
          <button
            type="button"
            id="mobile-menu-button"
            data-testid="mobile-menu-button"
            class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
            aria-expanded="false"
            aria-controls="mobile-menu"
          >
            <span class="sr-only">Open main menu</span>
            <!-- Icon when menu is closed -->
            <svg
              class="h-6 w-6 transition-transform"
              id="menu-icon"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Mobile menu, show/hide based on menu state -->
  <div class="md:hidden hidden" id="mobile-menu" data-testid="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1 border-t border-gray-200 dark:border-gray-700">
      {
        navItems.map((item) => (
          <a
            href={localizePath(currentLocale, item.href)}
            class={`block px-3 py-2 text-base font-medium rounded-md ${
              isActiveLocalized(item.href)
                ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400'
                : 'text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-800'
            }`}
            aria-current={isActiveLocalized(item.href) ? 'page' : undefined}
            aria-label={item['aria-label']}
          >
            {item.name}
          </a>
        ))
      }

      {user && (
        <>
          <div class="px-3 py-2 border-t border-gray-200 dark:border-gray-700 mt-3 pt-3">
            <a
              href={localizePath(currentLocale, '/dashboard')}
              class="flex items-center gap-3"
              aria-label="Account"
            >
              <img
                src={user.image || '/assets/svg/logo.svg'}
                alt="User avatar"
                class="h-8 w-8 rounded-full ring-2 ring-emerald-500/20"
                data-avatar-img
              />
              <div class="min-w-0">
                <div class="text-base font-medium text-gray-900 dark:text-white truncate">{user.name || 'Account'}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Account</div>
              </div>
            </a>
          </div>

          <!-- Mobile: Plan & Usage (lazy-loaded on first menu open) -->
          <div class="px-3 py-2 border-t border-gray-200 dark:border-gray-700">
            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Plan & Usage</div>
            <div class="px-1 pb-1 text-base">
              <div class="flex items-center justify-between">
                <span class="text-gray-600 dark:text-slate-300">Plan</span>
                <span id="user-plan-mobile" class="font-medium text-gray-900 dark:text-white">—</span>
              </div>
              <div class="mt-1.5 flex items-center justify-between">
                <span class="text-gray-600 dark:text-slate-300">Credits</span>
                <span id="user-credits-mobile" class="font-medium text-gray-900 dark:text-white">—</span>
              </div>
              <div class="mt-1.5 flex items-center justify-between">
                <span class="text-gray-600 dark:text-slate-300">Monthly quota remaining</span>
                <span id="user-quota-mobile" class="font-medium text-gray-900 dark:text-white">—</span>
              </div>
            </div>
          </div>

          <!-- Mobile: Logout -->
          <div class="px-3 py-2 border-t border-gray-200 dark:border-gray-700">
            <a
              href="/api/user/logout"
              class="block px-3 py-2 text-base font-medium rounded-md text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20"
              aria-label="Logout"
            >
              Abmelden
            </a>
          </div>
        </>
      )}

      <div class="px-3 py-2 border-t border-gray-200 dark:border-gray-700 mt-3 pt-3">
        <div class="flex items-center justify-between">
          <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Theme</div>
          <ThemeToggle />
        </div>
      </div>

      <div class="px-3 py-2 border-t border-gray-200 dark:border-gray-700">
        <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Language</div>
        <div class="flex flex-col space-y-1">
          <a
            href={setLocaleHref('de')}
            class={`block px-3 py-2 text-base rounded-md ${
              currentLocale === 'de'
                ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 font-medium'
                : 'text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-800'
            }`}
            data-astro-reload
          >
            Deutsch
          </a>
          <a
            href={setLocaleHref('en')}
            class={`block px-3 py-2 text-base rounded-md ${
              currentLocale === 'en'
                ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 font-medium'
                : 'text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-800'
            }`}
            data-astro-reload
          >
            English
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<script is:inline nonce={Astro.locals.cspNonce}>
  let mobileMenuInitialized = false;
  let languageDropdownInitialized = false;
  let userMenuInitialized = false;
  // Inline script for Cloudflare Pages build compatibility
  function initializeHeaderScripts() {
    console.log('[Header] 🚀 Initializing header scripts (inline version)');

    // === MOBILE MENU FUNCTIONALITY ===
    function initMobileMenu() {
      console.log('[Header] 🔄 Initializing mobile menu functionality');
      if (mobileMenuInitialized) {
        console.log('[Header] ℹ️ Mobile menu already initialized');
        return;
      }

      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');

      if (!mobileMenu) {
        console.error('[Header] ❌ Mobile menu element (#mobile-menu) not found');
        return;
      }

      if (!mobileMenuButton) {
        console.error('[Header] ❌ Mobile menu button (#mobile-menu-button) not found');
        return;
      }

      let isOpen = false;
      let mobileInfoLoaded = false;

      function toggleMenu() {
        console.log('[MobileMenu] 🔄 Toggling menu, current state:', isOpen);
        isOpen = !isOpen;

        if (isOpen) {
          mobileMenu.classList.remove('hidden');
          mobileMenu.classList.add('block');
          mobileMenuButton.setAttribute('aria-expanded', 'true');
          console.log('[MobileMenu] ✅ Menu opened');

          // Lazy-load plan & credits for mobile once (if elements exist)
          if (!mobileInfoLoaded) {
            const planEl = document.getElementById('user-plan-mobile');
            const creditsEl = document.getElementById('user-credits-mobile');
            const quotaElM = document.getElementById('user-quota-mobile');
            if (planEl || creditsEl) {
              fetch('/api/dashboard/billing-summary')
                .then((r) => (r.ok ? r.json() : Promise.reject(r)))
                .then((json) => {
                  if (json && json.success && json.data) {
                    const plan = String(json.data.plan ?? '—');
                    const credits =
                      typeof json.data.creditsRemaining === 'number'
                        ? String(json.data.creditsRemaining)
                        : '—';
                    const limit = Number(json.data.monthlyLimit || 0);
                    const used = Number(json.data.monthlyUsed || 0);
                    const remaining = Math.max(0, limit - used);
                    if (planEl) planEl.textContent = plan;
                    if (creditsEl) creditsEl.textContent = credits;
                    if (quotaElM) quotaElM.textContent = String(remaining);
                    // Defensive: update desktop placeholders if present and empty
                    const planDesktop = document.getElementById('user-plan');
                    const creditsDesktop = document.getElementById('user-credits');
                    const quotaDesktop = document.getElementById('user-quota');
                    if (planDesktop && !planDesktop.textContent) planDesktop.textContent = plan;
                    if (creditsDesktop && !creditsDesktop.textContent) creditsDesktop.textContent = credits;
                    if (quotaDesktop && !quotaDesktop.textContent) quotaDesktop.textContent = String(remaining);
                  }
                })
                .catch(() => {})
                .finally(() => {
                  mobileInfoLoaded = true;
                });
            } else {
              mobileInfoLoaded = true;
            }
          }
        } else {
          mobileMenu.classList.remove('block');
          mobileMenu.classList.add('hidden');
          mobileMenuButton.setAttribute('aria-expanded', 'false');
          console.log('[MobileMenu] ✅ Menu closed');
        }
      }

      // Event listeners
      mobileMenuButton.addEventListener('click', function (e) {
        console.log('[MobileMenu] 🖱️ Button clicked');
        e.preventDefault();
        e.stopPropagation();
        toggleMenu();
      });

      // Keyboard support
      mobileMenuButton.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleMenu();
        }
      });

      // Close on outside click
      document.addEventListener('click', function (e) {
        if (isOpen && !mobileMenu.contains(e.target) && !mobileMenuButton.contains(e.target)) {
          toggleMenu();
        }
      });

      // Close on ESC
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && isOpen) {
          toggleMenu();
        }
      });

      mobileMenuInitialized = true;
      console.log('[Header] ✅ Mobile menu initialized successfully');
    }

    // === LANGUAGE DROPDOWN FUNCTIONALITY ===
    function initLanguageDropdown() {
      console.log('[Header] 🔄 Initializing language dropdown functionality');
      if (languageDropdownInitialized) {
        console.log('[Header] ℹ️ Language dropdown already initialized');
        return;
      }

      const languageButton = document.getElementById('language-selector');
      const languageDropdown = document.getElementById('language-dropdown');

      if (!languageButton || !languageDropdown) {
        console.error('[Header] ❌ Language selector elements not found', {
          button: !!languageButton,
          dropdown: !!languageDropdown,
        });
        return;
      }

      let isOpen = false;

      function toggleDropdown() {
        console.log('[LanguageDropdown] 🔄 Toggling dropdown, current state:', isOpen);
        isOpen = !isOpen;

        if (isOpen) {
          // Show dropdown: remove opacity-0, scale-95, pointer-events-none
          languageDropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
          languageDropdown.classList.add('opacity-100', 'scale-100');
          languageButton.setAttribute('aria-expanded', 'true');
          console.log('[LanguageDropdown] ✅ Dropdown opened');
        } else {
          // Hide dropdown: add opacity-0, scale-95, pointer-events-none
          languageDropdown.classList.remove('opacity-100', 'scale-100');
          languageDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
          languageButton.setAttribute('aria-expanded', 'false');
          console.log('[LanguageDropdown] ✅ Dropdown closed');
        }
      }

      // Event listeners
      languageButton.addEventListener('click', function (e) {
        console.log('[LanguageDropdown] 🖱️ Button clicked');
        e.preventDefault();
        e.stopPropagation();
        toggleDropdown();
      });

      // Keyboard support
      languageButton.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleDropdown();
        }
      });

      // Close on outside click
      document.addEventListener('click', function (e) {
        if (isOpen && !languageDropdown.contains(e.target) && !languageButton.contains(e.target)) {
          toggleDropdown();
        }
      });

      // Close on ESC
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && isOpen) {
          toggleDropdown();
        }
      });

      languageDropdownInitialized = true;
      console.log('[Header] ✅ Language dropdown initialized successfully');
    }

    // === USER MENU DROPDOWN FUNCTIONALITY ===
    function initUserMenu() {
      if (userMenuInitialized) return;
      const button = document.getElementById('user-menu-button');
      const dropdown = document.getElementById('user-menu-dropdown');
      if (!button || !dropdown) {
        // No user or not rendered on this page
        userMenuInitialized = true; // prevent repeated checks
        return;
      }

      let isOpen = false;
      let infoLoaded = false;

      function setOpen(next) {
        isOpen = next;
        if (isOpen) {
          dropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
          dropdown.classList.add('opacity-100', 'scale-100');
          button.setAttribute('aria-expanded', 'true');
          if (!infoLoaded) {
            // Lazy-load plan & credits
            fetch('/api/dashboard/billing-summary')
              .then((r) => r.ok ? r.json() : Promise.reject(r))
              .then((json) => {
                if (json && json.success && json.data) {
                  const planEl = document.getElementById('user-plan');
                  const creditsEl = document.getElementById('user-credits');
                  const quotaEl = document.getElementById('user-quota');
                  if (planEl) planEl.textContent = String(json.data.plan ?? '—');
                  if (creditsEl)
                    creditsEl.textContent =
                      typeof json.data.creditsRemaining === 'number' ? String(json.data.creditsRemaining) : '—';
                  if (quotaEl) {
                    const limit = Number(json.data.monthlyLimit || 0);
                    const used = Number(json.data.monthlyUsed || 0);
                    const remaining = Math.max(0, limit - used);
                    quotaEl.textContent = String(remaining);
                  }
                }
              })
              .catch(() => {})
              .finally(() => {
                infoLoaded = true;
              });
          }
        } else {
          dropdown.classList.remove('opacity-100', 'scale-100');
          dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
          button.setAttribute('aria-expanded', 'false');
        }
      }

      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        setOpen(!isOpen);
      });

      document.addEventListener('click', (e) => {
        if (!isOpen) return;
        if (!dropdown.contains(e.target) && !button.contains(e.target)) setOpen(false);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen) setOpen(false);
      });

      userMenuInitialized = true;
    }

    // Scroll effect is handled by the HeaderScroll.astro Island.
    // Inline scroll logic was removed to avoid duplication and conflicts.

    // Initialize all modules
    try {
      initMobileMenu();
      initLanguageDropdown();
      initUserMenu();
      // Scroll effect handled by HeaderScroll.astro
      console.log('[Header] 🎉 All header functionality initialized successfully');
    } catch (error) {
      console.error('[Header] ❌ Failed to initialize header scripts:', error);
    }
  }

  // Initialize all header scripts when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeHeaderScripts);
  } else {
    initializeHeaderScripts();
  }
  // Re-initialize after Astro view transitions
  document.addEventListener('astro:after-swap', initializeHeaderScripts);
</script>

<style>
  /* Styles für die Header-Animation - wichtig: Spezifischere Selektoren verwenden */
  #site-header.header-visible {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  #site-header.header-hidden {
    transform: translateY(-100%);
    opacity: 0;
    pointer-events: none;
  }

  /* === OPTIMIZATION 2: Smooth CSS transitions === */
  #site-header {
    /* Explicit transitions for show/hide animations */
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s ease-out,
      backdrop-filter 0.3s ease-out,
      box-shadow 0.3s ease-out,
      border-color 0.3s ease-out;
  }

  /* === OPTIMIZATION 3: will-change only on interaction === */
  #site-header:hover,
  #site-header.header-transitioning {
    will-change: transform, opacity;
  }

  /* Glassmorphism effect */

  \n/* Focus styles for better keyboard navigation */
  a:focus-visible,
  button:focus-visible,
  [role="menuitem"]:focus-visible {
    outline: 2px solid #10b981;
    outline-offset: 2px;
    border-radius: 0.25rem;
  }
</style>
<style>
  /* High contrast mode support */
  @media (forced-colors: active) {
    a:focus-visible,
    button:focus-visible,
    [role='menuitem']:focus-visible {
      outline: 2px solid Highlight !important;
      outline-offset: 2px;
    }
  }
</style>
<!-- HeaderScroll-Komponente für Scroll-Effekt -->
<HeaderScroll />
