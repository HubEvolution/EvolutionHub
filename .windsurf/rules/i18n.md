---
trigger: always_on
scope: frontend
extends:
  - project-structure.md
  - tooling-and-style.md
  - testing-and-ci.md
priority: medium
---

# i18n Rules

## Zweck

Konsistente Internationalisierung (DE/EN) für Astro Pages, React Islands und API‑Responses – mit stabilen Locale‑Routen, klaren Key‑Konventionen, sicheren Fallbacks und testsicheren Patterns.

Repo‑Realität (wichtig):

- **Deutsch ist neutral** (kein `/de` Prefix).
- **Englisch nutzt `/en`**.
- Legacy `/de/...` ist erlaubt als Input, soll aber perspektivisch auf neutral redirecten.

## Muss

- Locale-Quelle & Strategie
  - Für Seiten/UI wird die Locale über die URL bestimmt (`/en/...` → `en`, sonst `de`):
    - `src/lib/i18n.ts` → `getLocale(pathname)`.
  - Für API‑Kontexte ohne Locale‑Pfad (oder wenn bewusst): Locale über `Accept-Language` bestimmen:
    - `src/lib/i18n/accept-language.ts` → `pickBestLanguage(header, 'de')`.

- Übersetzungen & Keys
  - Übersetzungsdateien liegen unter:
    - `src/locales/de.json`
    - `src/locales/en.json`
  - Neue UI‑Texte **nicht hardcoden**, sondern als Key in **beiden** Locales pflegen.
  - Keys sind **stabil** und beschreibend:
    - Namespace‑Stil: `area.section.label` (z. B. `header.nav.pricing`).
  - Keine “Ad‑hoc” Keys pro Component ohne Namespace (vermeidet Drift).

- Zugriff auf Übersetzungen (UI)
  - Übersetzung über `getI18n(locale)`:
    - `src/utils/i18n.ts`
  - Keys werden mit Punkt‑Notation aufgelöst (nested JSON).
  - Platzhalter:
    - Strings nutzen `{name}` / `{count}` / etc. und werden über `params` ersetzt.
  - Pluralisierung:
    - Objekt‑Form mit `zero|one|other` wird unterstützt (über `count`).

- Fallback-Verhalten (kontrolliert)
  - Wenn Key im Ziel‑Locale fehlt:
    - Fallback auf EN (Repo‑Pattern: `getI18n` versucht EN).
  - Wenn auch EN fehlt:
    - Es wird ein **sichtbarer Sentinel** zurückgegeben (`[de:key_fallback_not_found]`).
  - Missing Keys dürfen nicht “silent” als leerer String verschwinden.

- Locale‑Links & Routing
  - Interne Links müssen locale‑bewusst sein (insb. Header/Nav):
    - `src/lib/locale-path.ts` → `localizePath(locale, href)`
  - Locale‑Switching:
    - `src/lib/locale-path.ts` → `mapLocaleHref(targetLocale, Astro.url)`
  - Externe Links/`mailto:`/`tel:`/Hash/Query bleiben unverändert.

- Astro Typisierung
  - Locale‑abhängige Props/Frontmatter in `.astro` strikt typisieren (siehe Tooling & Style Rules).
  - Keine Alias‑Imports in Inline `type="module"` Scripts (siehe Cookies & Consent Rules) – i18n in Inline Scripts nur “plain JS” oder via server‑side rendering.

## Sollte

- Admin i18n konsistent halten
  - Admin Strings werden zentral aufgelöst (Pattern: `getAdminStrings()`), damit Admin‑UI nicht fragmentiert.
  - Strings sollten nicht doppelt in mehreren Modulen gepflegt werden.

- Arrays / strukturierte Übersetzungen
  - Für Array‑Values existiert ein Helper:
    - `src/utils/i18n.ts` → `getI18nArray(locale)`
  - Arrays sind nur für listenartige UI‑Blöcke (z. B. Bullet‑Listen) geeignet, nicht für komplexe Rich‑Text‑Strukturen.

- Locale‑Cookies (Auth/Redirects)
  - Redirect‑Flows dürfen Locale‑Cookies berücksichtigen (post‑auth):
    - `post_auth_locale`, `pref_locale` (siehe Auth Callback).
  - Beim Redirect soll – wenn möglich – `localizePath(locale, target)` genutzt werden, sofern `target` noch nicht lokalisiert ist.

- Tests
  - i18n‑kritische UI‑Flows (Header/Language Switch) sollten mindestens via E2E‑Smoke abgedeckt sein.
  - Key‑Drift vermeiden: optionaler Check, dass beide JSONs denselben Key‑Baum haben (Script/CI später möglich).

## Nicht

- Keine Hardcodes für UI‑Texte in React/Astro Seiten (außer “wirklich nicht user-facing”, z. B. technische IDs).
- Keine “gemischten Strategien”:
  - Kein `/de` als “Primär‑Prefix” (de bleibt neutral).
- Keine Locale‑Switches via Regex/Manual String Ops in Komponenten:
  - Nutze `localizePath` / `mapLocaleHref` / `navigateLocale` statt DIY.
- Keine stillen Fallbacks auf leere Strings.

## Checkliste

- [ ] Neue Texte in `src/locales/de.json` **und** `src/locales/en.json` ergänzt?
- [ ] Locale korrekt bestimmt (`getLocale()` für UI / `pickBestLanguage()` für API)?
- [ ] Interne Links locale‑aware (`localizePath`)?
- [ ] Language Switch nutzt `mapLocaleHref` (oder `navigateLocale`)?
- [ ] Fallbacks sind sichtbar (Sentinel), kein “silent fail”?

## Code‑Anker

- Locale / Navigation:
  - `src/lib/i18n.ts` (`Locale`, `getLocale`, `navigateLocale`)
  - `src/lib/i18n/accept-language.ts` (`parseAcceptLanguage`, `pickBestLanguage`)
  - `src/lib/locale-path.ts` (`localizePath`, `mapLocaleHref`, `switchLocalePath`)
- Translations:
  - `src/utils/i18n.ts` (`getI18n`, `getI18nArray`)
  - `src/locales/de.json`
  - `src/locales/en.json`
- Locale‑aware Header/Nav:
  - `src/components/Header.astro`

## CI/Gates

- `npm run lint`
- `npm run test`
- Bei Routing/Header Änderungen zusätzlich:
  - `npm run test:e2e`

## Referenzen

- [.windsurf/rules/project-structure.md](cci:7://file:///Users/lucas/Downloads/EvolutionHub_Bundle_v1.7_full/evolution-hub/.windsurf/rules/project-structure.md:0:0-0:0)
- [.windsurf/rules/tooling-and-style.md](cci:7://file:///Users/lucas/Downloads/EvolutionHub_Bundle_v1.7_full/evolution-hub/.windsurf/rules/tooling-and-style.md:0:0-0:0)
- [.windsurf/rules/testing-and-ci.md](cci:7://file:///Users/lucas/Downloads/EvolutionHub_Bundle_v1.7_full/evolution-hub/.windsurf/rules/testing-and-ci.md:0:0-0:0)
- [.windsurf/rules/cookies-and-consent.md](cci:7://file:///Users/lucas/Downloads/EvolutionHub_Bundle_v1.7_full/evolution-hub/.windsurf/rules/cookies-and-consent.md:0:0-0:0) (Inline Script Constraints)

## Changelog

- 2025-12-16: Erstfassung i18n (Locale Strategy DE neutral / EN prefix, locale-path helpers, JSON keys, fallbacks, tests).
