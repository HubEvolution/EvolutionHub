# Fast gates before pushing: unit tests + focused E2E auth smoke

echo "[pre-push] Running unit tests (Vitest)..."
npm run test:once || exit 1

echo "[pre-push] Preparing E2E smoke..."
# Avoid starting a new dev server in Playwright during git hooks (prevents port 8787 conflicts)
export PW_NO_SERVER=1

# Run a quick secrets scan before pushing
echo "[pre-push] Security scan (secrets)..."
npm run -s security:scan || exit 1

# If TEST_BASE_URL is unset, default to local dev URL for the ping check
if [ -z "$TEST_BASE_URL" ]; then
  export TEST_BASE_URL="http://127.0.0.1:8787"
fi

# Only run the quick E2E smoke when a server is actually reachable
if curl -sf -m 2 "$TEST_BASE_URL" >/dev/null 2>&1; then
  echo "[pre-push] Running Playwright auth redirect smoke (chromium) against $TEST_BASE_URL..."
  npm run test:e2e:chromium -- src/e2e/auth/welcome-redirect.spec.ts || exit 1
else
  echo "[pre-push] Skipping E2E smoke: no server reachable at $TEST_BASE_URL (set TEST_BASE_URL to remote to run)."
fi

echo "[pre-push] OK"
