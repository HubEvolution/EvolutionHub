# URL-basierte Internationalisierung (i18n)

## Übersicht

Dieses Projekt verwendet eine einfache, URL-basierte Internationalisierungslogik, um zwischen Deutsch (de) und Englisch (en) zu wechseln. Die Sprache wird anhand des Pfadpräfixes in der URL bestimmt.

## Kern-Implementierung

Die Kernfunktionen befinden sich in:

- [`src/lib/i18n.ts`](src/lib/i18n.ts:12)
- [`src/utils/i18n.ts`](src/utils/i18n.ts:23)

Die folgenden Abschnitte erklären die öffentlichen Funktionen und die empfohlenen Nutzungsweisen.

## Funktionen und Verhalten

### getLocale(pathname: string): 'de' | 'en'

- Zweck: Extrahiert das Locale aus dem URL-Pfad.
- Implementierung: [`src/lib/i18n.ts`](src/lib/i18n.ts:12)
- Verhalten:
  - Pfade, die mit `/en` beginnen (z.B. `/en/`, `/en/docs`) → `en`
  - Pfade, die mit `/de` beginnen (z.B. `/de/`) → `de`
  - Root oder Pfade ohne Präfix (z.B. `/`, `/docs`) → `de` (Projekt‑Default)

Beispiel:

```ts
import { getLocale } from '@/lib/i18n';
const locale = getLocale(Astro.url.pathname); // 'de' oder 'en'
```

### navigateLocale(locale: 'de' | 'en'): void

- Zweck: Programmatisches Wechseln der Sprache durch Anpassung der URL (client‑side).
- Implementierung: [`src/lib/i18n.ts`](src/lib/i18n.ts:40)
- Wichtige Hinweise:
  - Funktioniert nur im Browser (SSR‑safe: prüft `typeof window !== 'undefined'`).
  - Ersetzt vorhandene Locale‑Präfixe oder fügt bei Bedarf `/en` hinzu; `de` bleibt neutral (kein `/de`‑Prefix).

Beispiel:

```ts
import { navigateLocale } from '@/lib/i18n';
// Wechselt auf Englisch
navigateLocale('en');
```

### getI18n(locale: 'de' | 'en'): (key: string) => string

- Zweck: Liefert eine Translator‑Funktion `t(key)` für einfache Schlüssel‑basierte Übersetzungen.
- Implementierung: [`src/utils/i18n.ts`](src/utils/i18n.ts:23)
- Wichtige Nutzungsregel: Verwenden Sie nicht die Destrukturierung `{ t } = getI18n(...)`. Stattdessen:

```ts
const t = getI18n(locale);
t('pages.home.hero.title');
```

- Verhalten bei fehlenden Schlüsseln:
  - Wenn ein Schlüssel im aktuellen Locale fehlt, wird auf Englisch (`en`) zurückgefallen.
  - Wenn der Schlüssel auch im Fallback fehlt, erzeugt die Funktion einen plausiblen Platzhalter wie `[de:pages.foo_fallback_not_found]` und schreibt eine Warnung in die Konsole.

Beispiel (Astro‑Seite):

```astro
--- 
import { getLocale } from '@/lib/i18n';
import { getI18n } from '@/utils/i18n';
const locale = getLocale(Astro.url.pathname);
const t = getI18n(locale);
---
<h1>{t('pages.home.title')}</h1>
```

### getI18nArray(locale: 'de' | 'en'): (key: string) => string[]

- Zweck: Liefert Array‑Übersetzungen (z. B. für rotierende Texte) mit automatischem Fallback auf Englisch.
- Implementierung: [`src/utils/i18n.ts`](src/utils/i18n.ts:74)

Beispiel:

```ts
import { getI18nArray } from '@/utils/i18n';
const tArr = getI18nArray(locale);
const heroItems = tArr('pages.home.hero.typewriter'); // returns string[]
```

## Frontend‑Integration (Beispiele)

- Sprachumschalter im Header: `getLocale` und `navigateLocale` verwenden, um aktuellen Status anzuzeigen und zu wechseln.
  - Referenz‑Implementierung: [`src/components/Header.astro`](src/components/Header.astro:1)

- Dynamisches `<html lang>` und `hreflang`‑Links:
  - In: [`src/layouts/BaseLayout.astro`](src/layouts/BaseLayout.astro:1)
  - Beispiel:

```astro
--- 
import { getLocale } from '@/lib/i18n';
const locale = getLocale(Astro.url.pathname);
---
<html lang={locale}>
```

- Typewriter‑Beispiel:
  - Texte als Array via `getI18nArray` abrufen und an die Komponente übergeben:

```astro
import TypewriterComponent from '@/components/scripts/TypewriterComponent.astro';
const heroTypewriterTexts = getI18nArray(locale)('pages.home.hero.typewriter');
const heroTypewriterItems = heroTypewriterTexts.map(text => ({ text }));
<TypewriterComponent elementId="hero-typewriter" texts={heroTypewriterItems} defaultDelay={120} />
```

## Testing & Best Practices

- Objektwerte nicht direkt via `t()` laden: `t()` liefert Strings (inkl. Plural‑Auswahl), aber keine Objekte. Wenn Komponenten Maps benötigen (z. B. `statusMap`, `planLabels`), bauen Sie diese aus Einzel‑Keys auf oder nutzen Sie einen dedizierten Helper.

  Beispiel (Astro):

  ```ts
  const t = getI18n(locale);
  const statusMap = {
    active: t('pages.dashboard.billing.statusMap.active'),
    trialing: t('pages.dashboard.billing.statusMap.trialing'),
    past_due: t('pages.dashboard.billing.statusMap.past_due'),
    // ...
  };
  const planLabels = {
    free: t('pages.dashboard.profile.planLabels.free'),
    pro: t('pages.dashboard.profile.planLabels.pro'),
    premium: t('pages.dashboard.profile.planLabels.premium'),
    enterprise: t('pages.dashboard.profile.planLabels.enterprise'),
  };
  ```

- Unit‑Tests für i18n: Es existieren Tests in `tests/` die `getI18n`/`getI18nArray` gegen die Locale‑JSONs validieren (aufrufbar mit Vitest).
- Pflegen Sie die Locale‑JSONs (`src/locales/de.json`, `src/locales/en.json`) synchron, besonders bei Arrays (gleiche Reihenfolge/Längen sind nicht zwingend, sollten aber vergleichbar sein).

## Fallstricke / Hinweise

- Destrukturierung vermeiden: `const { t } = getI18n(locale)` führt nicht wie erwartet zu einer Funktion `t`; benutzen Sie `const t = getI18n(locale)`.
- SSR‑Sicherheit: Funktionen, die `window` oder `document` verwenden (z. B. `navigateLocale`) müssen in clientseitigem Kontext aufgerufen werden.
- Key‑Konventionen: Verwenden Sie konsistente Dot‑Paths (`pages.home.hero.title`) und dokumentieren Sie neue Keys in den Locale‑Dateien.

## Änderungen / Migration

- Hinweis: Der bisherige Default‑Export aus `@/lib/i18n` wurde entfernt; die Bibliothek benutzt jetzt benannte Exporte (`getLocale`, `navigateLocale`) und für Übersetzungen `getI18n(locale)` aus `@/utils/i18n`.

## Placeholder‑Politik (Impressum & Kontakt)

- Zweck: Solange keine finalen Rechts-/Firmendaten vorliegen, werden neutrale Platzhalter genutzt, um leere UI‑Strings zu vermeiden.
- Richtlinien:
  - Textfelder: EN „To be provided“, DE „Noch anzugeben“
  - Telefon/Fax: „+00 000 0000000“
  - E‑Mail: EN „`contact@example.com`“, DE „`kontakt@example.com`“
  - URLs: <https://example.com>
- Betroffene Keys (Beispiele):
  - `pages.impressum.sections.*`
  - `pages.kontakt.info.{provider,contact,represented_by,registration,vat,content_responsible,dispute_resolution,disclaimer.*}`

## Verifikation & Reporting

- Leere Werte prüfen:

```bash
reportnpm run i18n:
# Ausgabe: "i18n empty strings report" mit Zähler pro Locale
# CSV: reports/i18n-empty-keys.csv
```

- Schlüsseldifferenzen prüfen (EN/DE‑Parity):

```bash
npm run i18n:diff
# Erwartung: Missing in de: 0, Missing in en: 0
```

## Skript‑Kurzreferenz

- `i18n:report` – Listet leere Strings und aktualisiert `reports/i18n-empty-keys.csv`.
- `i18n:diff` – Prüft Key‑Parity zwischen `en.json` und `de.json`.
- `i18n:fill` – Hilfsskript zum Auffüllen fehlender Werte (mit Vorsicht verwenden).
- `i18n:identical` – Findet identische Werte (Qualitätscheck).
- `i18n:migrate`/`i18n:prune` – Migration/Pruning von Keys (nur bei Bedarf).
-
